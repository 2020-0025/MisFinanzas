@page "/Account/ResetPassword"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using System.Text
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using MisFinanzas.Domain.Entities
@using MisFinanzas.Components.Layout

@layout MinimalLayout

@inject IdentityRedirectManager RedirectManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager

<PageTitle>Restablecer Contraseña - Mis Finanzas</PageTitle>

<div class="auth-container-split">
    <div style="width: 100%; max-width: 550px; margin: 0 auto;">

        <!-- Hero Title -->
        <div class="glass-card animate-slide-up" style="padding: 40px; text-align: center; margin-bottom: 30px;">
            <span style="font-size: 64px; display: block; margin-bottom: 20px;">🔐</span>
            <h1 style="color: white; font-size: 2rem; margin-bottom: 15px; font-weight: 700;">
                Restablecer Contraseña
            </h1>
            <p style="color: white; font-size: 1rem;">
                Crea una nueva contraseña segura para tu cuenta
            </p>
        </div>

        <!-- Reset Password Form Card -->
        <div class="glass-card animate-slide-up animate-delay-1" style="padding: 40px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px;">
                <span style="font-size: 28px;">🔑</span>
                <h2 style="color: white; margin: 0; font-size: 1.5rem;">Nueva Contraseña</h2>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert" style="margin-bottom: 20px;">
                    @errorMessage
                </div>
            }

            <EditForm Model="Input" FormName="reset-password" OnValidSubmit="OnValidSubmitAsync" method="post">
                <DataAnnotationsValidator />

                <input type="hidden" name="Input.Code" value="@Input.Code" />

                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <InputText @bind-Value="Input.Email"
                               class="form-control"
                               id="email"
                               autocomplete="username"
                               placeholder="tu@email.com" />
                    <ValidationMessage For="() => Input.Email" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Nueva Contraseña</label>
                    <div class="password-input-wrapper">
                        <InputText type="password"
                                   @bind-Value="Input.Password"
                                   class="form-control"
                                   id="password"
                                   autocomplete="new-password"
                                   placeholder="Mínimo 6 caracteres" />
                        <button type="button"
                                class="password-toggle-btn"
                                id="password-toggle"
                                onclick="togglePasswordVisibility('password', 'password-toggle')"
                                title="Mostrar contraseña">
                            👁️
                        </button>
                    </div>
                    <ValidationMessage For="() => Input.Password" class="text-danger" />
                    <small class="form-text text-warning">
                        Debe contener mayúsculas, minúsculas y números
                    </small>
                </div>

                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Confirmar Contraseña</label>
                    <div class="password-input-wrapper">
                        <InputText type="password"
                                   @bind-Value="Input.ConfirmPassword"
                                   class="form-control"
                                   id="confirmPassword"
                                   autocomplete="new-password"
                                   placeholder="Repite tu contraseña" />
                        <button type="button"
                                class="password-toggle-btn"
                                id="confirmPassword-toggle"
                                onclick="togglePasswordVisibility('confirmPassword', 'confirmPassword-toggle')"
                                title="Mostrar contraseña">
                            👁️
                        </button>
                    </div>
                    <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger" />
                </div>

                <div class="login-footer-custom">
                    <button type="submit" class="btnLogin" disabled="@isLoading" style="margin: 0 auto;">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Restableciendo...</span>
                        }
                        else
                        {
                            <span>Restablecer Contraseña</span>
                        }
                    </button>
                </div>
            </EditForm>

            <div class="auth-footer">
                <p>
                    ¿Recordaste tu contraseña? <a class="text-info" href="/Account/Login">Inicia sesión aquí</a>
                </p>
            </div>
        </div>

        <!-- Security Info Card -->
        <div class="glass-card animate-slide-up animate-delay-2" style="padding: 25px; margin-top: 20px; background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3);">
            <div style="display: flex; gap: 15px; align-items: flex-start;">
                <span style="font-size: 32px;">🛡️</span>
                <div>
                    <h3 style="color: white; margin: 0 0 10px 0; font-size: 1.1rem;">Contraseña Segura</h3>
                    <p style="color: white; margin: 0; line-height: 1.6; font-size: 0.95rem;">
                        Asegúrate de crear una contraseña que combine letras mayúsculas, minúsculas y números para mayor seguridad.
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>

<FloatingHelpButton OnClick="GotoHome" Icono="🏠" Titulo="Ir al Inicio" Bottom="90" />

@code {
    private string? errorMessage;
    private bool isLoading = false;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? Code { get; set; }

    protected override void OnInitialized()
    {
        if (Code is null)
        {
            RedirectManager.RedirectTo("Account/InvalidPasswordReset");
        }

        Input.Code = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(Code));
    }

    private void GotoHome()
    {
        NavigationManager.NavigateTo("/");
    }

    private async Task OnValidSubmitAsync()
    {
        isLoading = true;
        errorMessage = null;

        var user = await UserManager.FindByEmailAsync(Input.Email);
        if (user is null)
        {
            // Don't reveal that the user does not exist
            RedirectManager.RedirectTo("Account/ResetPasswordConfirmation");
            return;
        }

        var result = await UserManager.ResetPasswordAsync(user, Input.Code, Input.Password);
        if (result.Succeeded)
        {
            RedirectManager.RedirectTo("Account/ResetPasswordConfirmation");
        }
        else
        {
            errorMessage = $"Error: {string.Join(", ", result.Errors.Select(e => e.Description))}";
            isLoading = false;
        }
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "El email es requerido")]
        [EmailAddress(ErrorMessage = "Email inválido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "La contraseña es requerida")]
        [StringLength(100, ErrorMessage = "La {0} debe tener al menos {2} y máximo {1} caracteres.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm password")]
        [Compare("Password", ErrorMessage = "Las contraseñas no coinciden.")]
        public string ConfirmPassword { get; set; } = "";

        [Required]
        public string Code { get; set; } = "";
    }
}