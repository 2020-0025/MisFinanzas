@page "/Account/Manage/ChangePassword"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using MisFinanzas.Domain.Entities
@using MisFinanzas.Components.Layout

@layout MinimalLayout

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<ChangePassword> Logger
@inject NavigationManager NavigationManager

<PageTitle>Cambiar Contraseña - Mis Finanzas</PageTitle>

<div class="auth-container-split">
    <div style="width: 100%; max-width: 550px; margin: 0 auto;">

        <!-- Hero Title -->
        <div class="glass-card animate-slide-up" style="padding: 40px; text-align: center; margin-bottom: 30px;">
            <span style="font-size: 64px; display: block; margin-bottom: 20px;">🔐</span>
            <h1 style="color: white; font-size: 2rem; margin-bottom: 15px; font-weight: 700;">
                Cambiar Contraseña
            </h1>
            <p style="color: white; font-size: 1rem;">
                Actualiza tu contraseña para mantener tu cuenta segura
            </p>
        </div>

        <!-- Change Password Form Card -->
        <div class="glass-card animate-slide-up animate-delay-1" style="padding: 40px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px;">
                <span style="font-size: 28px;">🔑</span>
                <h2 style="color: white; margin: 0; font-size: 1.5rem;">Nueva Contraseña</h2>
            </div>

            @if (!string.IsNullOrEmpty(message))
            {
                @if (message.Contains("successfully") || message.Contains("exitosamente"))
                {
                    <div class="alert alert-success" role="alert" style="margin-bottom: 20px; background: rgba(76, 175, 80, 0.2); border: 1px solid rgba(76, 175, 80, 0.5);">
                        ✅ @message
                    </div>
                }
                else
                {
                    <div class="alert alert-danger" role="alert" style="margin-bottom: 20px;">
                        ❌ @message
                    </div>
                }
            }

            <EditForm Model="Input" FormName="change-password" OnValidSubmit="OnValidSubmitAsync" method="post">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label for="old-password" class="form-label">Old password</label>
                    <div class="password-input-wrapper">
                        <InputText type="password"
                                   @bind-Value="Input.OldPassword"
                                   class="form-control"
                                   id="old-password"
                                   autocomplete="current-password"
                                   placeholder="Please enter your old password." />
                        <button type="button"
                                class="password-toggle-btn"
                                id="old-password-toggle"
                                onclick="togglePasswordVisibility('old-password', 'old-password-toggle')"
                                title="Mostrar contraseña">
                            👁️
                        </button>
                    </div>
                    <ValidationMessage For="() => Input.OldPassword" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="new-password" class="form-label">New password</label>
                    <div class="password-input-wrapper">
                        <InputText type="password"
                                   @bind-Value="Input.NewPassword"
                                   class="form-control"
                                   id="new-password"
                                   autocomplete="new-password"
                                   placeholder="Please enter your new password." />
                        <button type="button"
                                class="password-toggle-btn"
                                id="new-password-toggle"
                                onclick="togglePasswordVisibility('new-password', 'new-password-toggle')"
                                title="Mostrar contraseña">
                            👁️
                        </button>
                    </div>
                    <ValidationMessage For="() => Input.NewPassword" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="confirm-password" class="form-label">Confirm password</label>
                    <div class="password-input-wrapper">
                        <InputText type="password"
                                   @bind-Value="Input.ConfirmPassword"
                                   class="form-control"
                                   id="confirm-password"
                                   autocomplete="new-password"
                                   placeholder="Please confirm your new password." />
                        <button type="button"
                                class="password-toggle-btn"
                                id="confirm-password-toggle"
                                onclick="togglePasswordVisibility('confirm-password', 'confirm-password-toggle')"
                                title="Mostrar contraseña">
                            👁️
                        </button>
                    </div>
                    <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger" />
                </div>

                <div class="login-footer-custom">
                    <button type="submit" class="btnLogin" style="margin: 0 auto;">
                        🔒 Actualizar Contraseña
                    </button>
                </div>
            </EditForm>

            <div class="auth-footer" style="margin-top: 25px; padding-top: 25px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <p>
                    <a class="text-info" href="/profile">← Volver a mi perfil</a>
                </p>
            </div>
        </div>

        <!-- Security Tips Card -->
        <div class="glass-card animate-slide-up animate-delay-2" style="padding: 25px; margin-top: 20px; background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3);">
            <div style="display: flex; gap: 15px; align-items: flex-start;">
                <span style="font-size: 32px;">🛡️</span>
                <div>
                    <h3 style="color: white; margin: 0 0 10px 0; font-size: 1.1rem;">Contraseña Segura</h3>
                    <p style="color: white; margin: 0; line-height: 1.6; font-size: 0.95rem;">
                        Usa una combinación de letras mayúsculas, minúsculas y números. Evita usar la misma contraseña en múltiples sitios.
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>

<a href="/" class="fab-help" style="bottom: 90px;" title="Ir al Inicio">🏠</a>

@code {
    private string? message;
    private ApplicationUser user = default!;
    private bool hasPassword;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        if (HttpContext == null)
        {
            return;
        }

        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        hasPassword = await UserManager.HasPasswordAsync(user);
        if (!hasPassword)
        {
            RedirectManager.RedirectTo("Account/Manage/SetPassword");
        }
    }

    private async Task OnValidSubmitAsync()
    {
        var changePasswordResult = await UserManager.ChangePasswordAsync(user, Input.OldPassword, Input.NewPassword);
        if (!changePasswordResult.Succeeded)
        {
            message = $"Error: {string.Join(", ", changePasswordResult.Errors.Select(error => error.Description))}";
            return;
        }

        await SignInManager.RefreshSignInAsync(user);
        Logger.LogInformation("User changed their password successfully.");

        message = "Tu contraseña ha sido actualizada exitosamente.";
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "La contraseña actual es requerida")]
        [DataType(DataType.Password)]
        [Display(Name = "Current password")]
        public string OldPassword { get; set; } = "";

        [Required(ErrorMessage = "La nueva contraseña es requerida")]
        [StringLength(100, ErrorMessage = "La {0} debe tener al menos {2} y máximo {1} caracteres.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "New password")]
        public string NewPassword { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm new password")]
        [Compare("NewPassword", ErrorMessage = "Las contraseñas no coinciden.")]
        public string ConfirmPassword { get; set; } = "";
    }
}