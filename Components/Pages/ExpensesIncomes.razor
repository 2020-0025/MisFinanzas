@page "/expenses-incomes"
@rendermode InteractiveServer
@attribute [Authorize]
@using MisFinanzas.Domain.DTOs
@using MisFinanzas.Domain.Enums
@using MisFinanzas.Infrastructure.Interfaces
@using MisFinanzas.Controllers
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@inject IExpenseIncomeService ExpenseIncomeService
@inject ICategoryService CategoryService
@inject IBudgetService BudgetService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IReportService ReportService
@inject IPdfReportGenerator PdfReportGenerator
@inject IExcelReportGenerator ExcelReportGenerator
@inject ITemporaryFileCache FileCache
@inject IWebHostEnvironment WebHostEnvironment
@implements IDisposable

<PageTitle>Gastos e Ingresos - Mis Finanzas</PageTitle>

<div class="expenses-container">
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="mb-3 mb-md-0">
                <h1 class="text-white">💸 Gastos e Ingresos</h1>
                <p class="mb-0 text-white">Registra tus Gastos e Ingresos</p>
            </div>
        </div>
        <div class="btnSaveGroup gap-2">
            <button class="btnAddExpenses" id="expenses-add-expense-button" @onclick="() => OpenModal(TransactionType.Expense)">
                ➕ Agregar gasto
            </button>
            <button class="btnAddIncomes" id="expenses-add-income-button" @onclick="() => OpenModal(TransactionType.Income)">
                ➕ Agregar ingreso
            </button>
        </div>
    </div>

    <!-- Balance -->
    <div class="row mb-4" id="expenses-balance-cards">
        <div class="col-md-3">
            <div class="balance-card income">
                <div class="balance-icon">📈</div>
                <div class="balance-info">
                    <p class="text-success">Total Ingresos</p>
                    <h3>@totalIngresos.ToString("C")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="balance-card loan">
                <div class="balance-icon">🏦</div>
                <div class="balance-info">
                    <p class="text-info">Adquirido en préstamos</p>
                    <h3>@totalAjustes.ToString("C")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="balance-card expense">
                <div class="balance-icon">📉</div>
                <div class="balance-info">
                    <p class="text-danger">Total Gastos</p>
                    <h3>@totalGastos.ToString("C")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="balance-card balance">
                <div class="balance-icon">💵</div>
                <div class="balance-info">
                    <p class="text-info">Balance</p>
                    <h3>@balance.ToString("C")</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Filtros de Reportes -->
    <div class="glass-card mb-4" id="expenses-report-panel">
        <div class="card-header">
            <h4 class="text-white">📊 Generar Reporte</h4>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Período -->
                <div class="col-md-3">
                    <label class="form-label text-white">Período</label>
                    <select class="form-select glass-card text-white border-primary" @bind="reportPeriodType">
                        <option value="@ReportPeriodType.LastWeek">Última semana</option>
                        <option value="@ReportPeriodType.LastMonth">Último mes</option>
                        <option value="@ReportPeriodType.Last3Months">Últimos 3 meses</option>
                        <option value="@ReportPeriodType.Last6Months">Últimos 6 meses</option>
                        <option value="@ReportPeriodType.LastYear">Último año</option>
                        <option value="@ReportPeriodType.Custom">Personalizado</option>
                    </select>
                </div>

                <!-- Fechas personalizadas (solo si es Custom) -->
                @if (reportPeriodType == ReportPeriodType.Custom)
                {
                    <div class="col-md-2">
                        <label class="form-label text-white">Fecha Inicio</label>
                        <input type="date" class="form-control border-primary" @bind="customStartDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-white">Fecha Fin</label>
                        <input type="date" class="form-control border-primary" @bind="customEndDate" />
                    </div>
                }

                <!-- Tipo de transacción -->
                <div class="col-md-3">
                    <label class="form-label text-white">Tipo</label>
                    <select class="form-select glass-card text-white border-primary" @bind="reportTransactionType">
                        <option value="">Ambos</option>
                        <option value="@TransactionType.Income">Solo Ingresos</option>
                        <option value="@TransactionType.Expense">Solo Gastos</option>
                    </select>
                </div>

                <!-- Categoría -->
                <div class="col-md-3">
                    <label class="form-label text-white">Categoría</label>
                    <select class="form-select glass-card text-white border-primary" @bind="reportCategoryId">
                        <option value="0">Todas las categorías</option>
                        @foreach (var category in allCategories)
                        {
                            <option value="@category.CategoryId">@category.Icon @category.Title</option>
                        }
                    </select>
                </div>

                <!-- Botones -->
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btnExportPdf" id="expenses-download-pdf" @onclick="GeneratePdfReport" disabled="@isGeneratingPdf">
                            @if (isGeneratingPdf)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            📄 Descargar PDF
                        </button>
                        <button class="btnExportExcel" id="expenses-download-excel" @onclick="GenerateExcelReport" disabled="@isGeneratingExcel">
                            @if (isGeneratingExcel)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            📊 Descargar Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensajes -->
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="custom-alert error @(showErrorMessage ? "show" : "")">
            <span class="alert-icon">✕</span>
            <span class="alert-text">@errorMessage</span>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="custom-alert success @(showSuccessMessage ? "show" : "")">
            <span class="alert-icon">✓</span>
            <span class="alert-text">@successMessage</span>
        </div>
    }

    <!-- Tabla de Transacciones -->
    <div class="transactions-card" id="expenses-history-table">
        <div class="card-header">
            <h4>📋 Historial</h4>
        </div>
        <div class="card-body">
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-light" role="status"></div>
                    <p class="text-white mt-3">Cargando transacciones...</p>
                </div>
            }
            else if (expensesIncomes == null || !expensesIncomes.Any())
            {
                <div class="text-center py-5">
                    <p class="text-white">No hay registros</p>
                    <p class="text-white">Comienza agregando un gasto o ingreso</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-dark">
                        <thead>
                            <tr class="text-white">
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Categoría</th>
                                <th>Descripción</th>
                                <th>Monto</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in expensesIncomes)
                            {
                                <tr>
                                    <td>
                                        <small class="text-white">@item.Date.ToString("dd/MM/yyyy")</small>
                                    </td>
                                    <td>
                                        <span class="badge @(item.Type ==
                                            TransactionType.Income ? "bg-success-custom" :
                                            (item.Type == TransactionType.Expense ? "bg-danger-custom" :
                                             "bg-info-custom"))">
                                            @item.TypeDisplay
                                        </span>
                                    </td>
                                    <td>
                                        <span class="text-white">@item.CategoryIcon @item.CategoryTitle</span>
                                    </td>
                                    <td class="text-white">
                                        @(item.Description ?? "-")
                                    </td>
                                    <td>
                                          <strong class="@(item.Type == TransactionType.Income ? "text-success" :
                                               (item.Type == TransactionType.Expense ? "text-danger" : "text-info"))">
                                               @item.Amount.ToString("C")
                                          </strong>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-warning"
                                                    id="@(GetPagedTransactions().First() == item ? "expenses-edit-button" : "")"
                                                    style="background-color:rgba(255, 193, 7, 0.25);"
                                                    @onclick="() => EditTransaction(item)">
                                                <span style="font-size: 13px;">📝</span>
                                            </button>
                                            <button class="btn btn-danger"
                                                    id="@(GetPagedTransactions().First() == item ? "expenses-delete-button" : "")"
                                                    style="background-color:rgba(244, 67, 54, 0.25);" 
                                                    @onclick="() => ConfirmDelete(item.Id, item.Description ?? item.CategoryTitle)">
                                                <span style="font-size: 13px;">🗑️</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <!-- Controles de Paginación -->
                    <div class="pagination-container mt-3" id="expenses-pagination-container">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <!-- Selector de tamaño de página -->
                            <div class="d-flex align-items-center gap-2">
                                <label class="text-white mb-0">Mostrar:</label>
                                <select class="form-select form-select-sm glass-card text-white border-primary"
                                        id="expenses-page-size-selector"
                                        style="width: auto;"
                                        @onchange="@(e => ChangePageSize(int.Parse(e.Value?.ToString() ?? "10")))">
                                    <option value="5" selected="@(pageSize == 5)">5</option>
                                    <option value="10" selected="@(pageSize == 10)">10</option>
                                    <option value="25" selected="@(pageSize == 25)">25</option>
                                    <option value="50" selected="@(pageSize == 50)">50</option>
                                    <option value="100" selected="@(pageSize == 100)">100</option>
                                </select>
                                <span class="text-white">registros por página</span>
                            </div>

                            <!-- Información de registros -->
                            <div class="text-white">
                                Mostrando @((currentPage - 1) * pageSize + 1)
                                a @(Math.Min(currentPage * pageSize, expensesIncomes.Count))
                                de @expensesIncomes.Count registros
                            </div>

                            <!-- Botones de navegación -->
                            <div class="btn-group" role="group">
                                <button type="button"
                                        class="btn btn-sm btn-outline-light text-white border-primary"
                                        id="expenses-previous-button"
                                        @onclick="PreviousPage"
                                        disabled="@(currentPage == 1)">
                                    ‹ Anterior
                                </button>

                                @for (int i = 1; i <= totalPages; i++)
                                {
                                    var pageNumber = i;
                                    @if (totalPages <= 7 ||
                                                                pageNumber == 1 ||
                                                                pageNumber == totalPages ||
                                                                (pageNumber >= currentPage - 1 && pageNumber <= currentPage + 1))
                                    {
                                        <button type="button"
                                                class="btn btn-sm @(currentPage == pageNumber ? "btn-primary-custom" : "btn-outline-light")"
                                                @onclick="() => GoToPage(pageNumber)">
                                            @pageNumber
                                        </button>
                                    }
                                    else if (pageNumber == currentPage - 2 || pageNumber == currentPage + 2)
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-light" disabled>...</button>
                                    }
                                }

                                <button type="button"
                                        class="btn btn-sm btn-outline-light text-white border-primary"
                                        id="expenses-next-button"
                                        @onclick="NextPage"
                                        disabled="@(currentPage == totalPages)">
                                    Siguiente ›
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal Agregar/Editar -->
@if (showModal)
{
    <div class="modal-overlay">
        <div class="modal-content text-white" @onclick:stopPropagation="true">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    @(isEditing ? "✏️ Editar" : (currentType == TransactionType.Income ? "📈 Agregar ingreso" : "📉 Agregar gasto"))
                </h5>
                <button class="btn-close-custom" @onclick="CloseModal">✕</button>
            </div>
            <div class="modal-body">
                <EditForm Model="formModel" OnValidSubmit="SaveTransaction">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <label class="form-label">Categoría</label> <br />
                        <label class="form-label text-warning">Debes tener al menos una categoría creada</label>
                        <InputSelect @bind-Value="formModel.CategoryId" class="form-select glass-card text-white border-primary">
                            <option value="0">Selecciona una categoría</option>
                            @foreach (var category in availableCategories)
                            {
                                <option value="@category.CategoryId">@category.Icon @category.Title</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => formModel.CategoryId" class="text-danger" />
                        @if (!string.IsNullOrEmpty(categoryValidationError))
                        {
                            <div class="text-danger small mt-1">@categoryValidationError</div>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Monto</label>
                        <InputNumber @bind-Value="formModel.Amount" class="form-control" placeholder="0.00" />
                        <ValidationMessage For="() => formModel.Amount" class="text-danger" />
                        @if (!string.IsNullOrEmpty(amountValidationError))
                        {
                            <div class="text-danger small mt-1">@amountValidationError</div>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fecha</label>
                        <InputDate @bind-Value="formModel.Date" class="form-control" />
                        <ValidationMessage For="() => formModel.Date" class="text-danger" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripción (Opcional)</label>
                        <InputTextArea @bind-Value="formModel.Description" class="form-control" rows="3" placeholder="Ej: Compra en supermercado" />
                    </div>

                    <div class="modal-footer-custom gap-2">
                        <button type="submit" class=" btn btnSaveEdit" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <span>Guardar</span>
                            }
                        </button>
                        <button type="button" class="btn btnCancel" @onclick="CloseModal">Cancelar</button>
                    </div>
                </EditForm>
            </div>
        </div>

    </div>
}

<!-- Modal de Confirmación de Eliminación -->
@if (showDeleteModal)
{
    <div class="modal-overlay">
        <div class="modal-content text-white" @onclick:stopPropagation="true">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">⚠️ Confirmar eliminación</h5>
                <button class="btn-close-custom" @onclick="CancelDelete">✕</button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar este registro?</p>
                <p class="text-white"><strong>@transactionToDelete</strong></p>
                <p class="text-danger mb-0">
                    <small>Esta acción no se puede deshacer.</small>
                </p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btnCancel" @onclick="CancelDelete">Cancelar</button>
                <button type="button" class="btnDelete" @onclick="DeleteTransaction">
                    <span style="font-size: 13px;">🗑️</span> Eliminar
                </button>
            </div>
        </div>

    </div>
}

<!-- Botón flotante del Asistente de IA -->
<FloatingAIButton OnClick="ToggleAIModal" Bottom="200" />

<!-- Modal del Asistente de IA -->
<AIAssistantModal @bind-IsVisible="showAIModal" />

<FloatingHelpButton OnClick="StartTour" Icono="?" Titulo="Ayuda" Bottom="90" />

<FloatingHelpButton OnClick="GotoHome" Icono="🏠" Titulo="Ir al Inicio" Bottom="140" />

@code {
    private bool isLoading = true;
    private string currentUserId = string.Empty;
    private string currentUserName = string.Empty;

    // Listas
    private List<ExpenseIncomeDto> expensesIncomes = new();
    private List<CategoryDto> allCategories = new();
    private List<CategoryDto> availableCategories = new();

    // Balance
    private decimal totalIngresos = 0;
    private decimal totalGastos = 0;
    private decimal totalAjustes = 0;
    private decimal balance = 0;

    // Mensajes
    private string? successMessage;
    private string? errorMessage;
    private string? categoryValidationError;
    private string? amountValidationError;
    private bool showSuccessMessage = false;
    private bool showErrorMessage = false;
    private System.Threading.Timer? successTimer;
    private System.Threading.Timer? errorTimer;

    // Modal
    private bool showModal = false;
    private bool isSaving = false;
    private bool isEditing = false;
    private TransactionType currentType = TransactionType.Expense;
    private ExpenseIncomeFormModel formModel = new();

    // Modal de eliminación
    private bool showDeleteModal = false;
    private int transactionIdToDelete;
    private string? transactionToDelete;

    // Variables para reportes
    private ReportPeriodType reportPeriodType = ReportPeriodType.LastMonth;
    private string reportTransactionType = "";
    private int reportCategoryId = 0;
    private DateTime? customStartDate;
    private DateTime? customEndDate;
    private bool isGeneratingPdf = false;
    private bool isGeneratingExcel = false;

    //Tour automático
    private bool _tourLaunched = false;

    private bool showAIModal = false;

    // Variables de paginación
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages => expensesIncomes == null || !expensesIncomes.Any()
        ? 0
        : (int)Math.Ceiling(expensesIncomes.Count / (double)pageSize);

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            currentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
            currentUserName = user.Identity?.Name ?? "Usuario";

            if (!string.IsNullOrEmpty(currentUserId))
            {
                await LoadData();
            }
        }

        isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_tourLaunched)
        {
            // NUEVO: Iniciar tour automáticamente si es primera vez
            _tourLaunched = true;
            await Task.Delay(500); // Pequeño delay para que cargue la UI
            await JSRuntime.InvokeVoidAsync("tourService.startTourIfFirstTime", "expenses");
        }
    }

    //Paginación
    private List<ExpenseIncomeDto> GetPagedTransactions()
    {
        if (expensesIncomes == null || !expensesIncomes.Any())
            return new List<ExpenseIncomeDto>();

        return expensesIncomes
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    //Botones flotantes
    private async Task StartTour()
    {
        await JSRuntime.InvokeVoidAsync("tourService.startExpensesIncomesTour");
    }
    // Lógica para redirigir
    private void GotoHome()
    {
        NavigationManager.NavigateTo("/"); // Redirige al Home
    }

    private void ToggleAIModal()
    {
        showAIModal = !showAIModal;
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > totalPages)
            return;

        currentPage = page;
        StateHasChanged();
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            StateHasChanged();
        }
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            StateHasChanged();
        }
    }

    private void ChangePageSize(int newSize)
    {
        pageSize = newSize;
        currentPage = 1; // Resetear a la primera página
        StateHasChanged();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;

            // Cargar transacciones
            expensesIncomes = await ExpenseIncomeService.GetAllByUserAsync(currentUserId);

            // Cargar categorías
            allCategories = await CategoryService.GetAllByUserAsync(currentUserId);

            // Calcular balance
            totalIngresos = await ExpenseIncomeService.GetTotalIngresosByUserAsync(currentUserId);
            totalGastos = await ExpenseIncomeService.GetTotalGastosByUserAsync(currentUserId);
            totalAjustes = await ExpenseIncomeService.GetTotalAdjustmentsByUserAsync(currentUserId);
            balance = totalIngresos + totalAjustes - totalGastos;
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error al cargar datos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenModal(TransactionType type)
    {
        currentType = type;
        isEditing = false;
        formModel = new ExpenseIncomeFormModel
        {
            Date = DateTime.Now,
            Type = type
        };

        // Filtrar categorías por tipo
        availableCategories = allCategories
            .Where(c => c.Type == type)
            .ToList();

        showModal = true;
    }

    private void EditTransaction(ExpenseIncomeDto transaction)
    {
        isEditing = true;
        currentType = transaction.Type;

        formModel = new ExpenseIncomeFormModel
        {
            Id = transaction.Id,
            CategoryId = transaction.CategoryId,
            Amount = transaction.Amount,
            Date = transaction.Date,
            Description = transaction.Description,
            Type = transaction.Type
        };

        // Filtrar categorías por tipo
        availableCategories = allCategories
            .Where(c => c.Type == currentType)
            .ToList();

        showModal = true;
    }

    private async Task SaveTransaction()
    {
        try
        {
            // Limpiar errores previos
            categoryValidationError = null;
            amountValidationError = null;

            if (formModel.CategoryId == 0)
            {
                categoryValidationError = "Debes seleccionar una categoría";
                return;
            }

            if (formModel.Amount <= 0)
            {
                amountValidationError = "El monto debe ser mayor a cero";
                return;
            }

            isSaving = true;

            var dto = new ExpenseIncomeDto
            {
                Id = formModel.Id,
                CategoryId = formModel.CategoryId,
                Amount = formModel.Amount,
                Date = formModel.Date,
                Description = formModel.Description,
                Type = formModel.Type
            };

            if (isEditing)
            {
                var result = await ExpenseIncomeService.UpdateAsync(formModel.Id, dto, currentUserId);

                if (result)
                {
                    ShowSuccessMessage("Transacción actualizada correctamente");
                    CloseModal();
                    await LoadData();
                }
                else
                {
                    ShowErrorMessage("No se pudo actualizar la transacción");
                }
            }
            else
            {
                var result = await ExpenseIncomeService.CreateAsync(dto, currentUserId!);

                if (result.Success)
                {
                    ShowSuccessMessage($"{(formModel.Type == TransactionType.Income ? "Ingreso" : "Gasto")} agregado correctamente");
                    CloseModal();
                    await LoadData();
                }
                else
                {
                    ShowErrorMessage(result.Error ?? "No se pudo crear la transacción");
                }
            }
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void CloseModal()
    {
        showModal = false;
        showDeleteModal = false;
        formModel = new();
        isEditing = false;
        categoryValidationError = null;
        amountValidationError = null;
    }

    private void ConfirmDelete(int id, string? description)
    {
        transactionIdToDelete = id;
        transactionToDelete = description ?? "esta transacción";
        showDeleteModal = true;
    }

    private void CancelDelete()
    {
        showDeleteModal = false;
        transactionIdToDelete = 0;
        transactionToDelete = null;
    }

    private async Task DeleteTransaction()
    {
        try
        {
            var result = await ExpenseIncomeService.DeleteAsync(transactionIdToDelete, currentUserId);

            if (result)
            {
                ShowSuccessMessage("Transacción eliminada correctamente");
                showDeleteModal = false;
                transactionIdToDelete = 0;
                transactionToDelete = null;
                await LoadData();
            }
            else
            {
                ShowErrorMessage("No se pudo eliminar la transacción");
            }
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error: {ex.Message}");
        }
    }

    private class ExpenseIncomeFormModel
    {
        public int Id { get; set; }

        [Required(ErrorMessage = "La categoría es requerida")]
        public int CategoryId { get; set; }

        [Required(ErrorMessage = "El monto es requerido")]
        [Range(0.01, double.MaxValue, ErrorMessage = "El monto debe ser mayor a cero")]
        public decimal Amount { get; set; }

        [Required(ErrorMessage = "La fecha es requerida")]
        public DateTime Date { get; set; } = DateTime.Now;

        public string? Description { get; set; }

        public TransactionType Type { get; set; }
    }

    #region Métodos de Reportes

    private async Task GeneratePdfReport()
    {
        try
        {
            isGeneratingPdf = true;
            StateHasChanged();

            // Validar fechas personalizadas
            if (reportPeriodType == ReportPeriodType.Custom)
            {
                if (!customStartDate.HasValue || !customEndDate.HasValue)
                {
                    ShowErrorMessage("Debes seleccionar ambas fechas para el período personalizado");
                    return;
                }

                if (customStartDate.Value > customEndDate.Value)
                {
                    ShowErrorMessage("La fecha de inicio no puede ser mayor que la fecha fin");
                    return;
                }
            }

            // Crear filtro
            var filter = new ReportFilterDto
            {
                UserId = currentUserId!,
                UserName = currentUserName ?? "Usuario",
                PeriodType = reportPeriodType,
                CustomStartDate = customStartDate,
                CustomEndDate = customEndDate,
                TransactionTypeFilter = string.IsNullOrEmpty(reportTransactionType)
                    ? null
                    : Enum.Parse<TransactionType>(reportTransactionType),
                CategoryIdFilter = reportCategoryId > 0 ? reportCategoryId : null
            };

            // Generar datos del reporte
            var reportData = await ReportService.GenerateReportDataAsync(filter);

            // Generar PDF
            var logoPath = Path.Combine(WebHostEnvironment.WebRootPath, "images", "MisFinanzas.png");

            // 🔍 DEBUG COMPLETO
            Console.WriteLine($"WebRootPath: {WebHostEnvironment.WebRootPath}");
            Console.WriteLine($"Logo path: {logoPath}");
            Console.WriteLine($"File exists: {File.Exists(logoPath)}");

            if (File.Exists(logoPath))
            {
                var fileInfo = new FileInfo(logoPath);
                Console.WriteLine($"File size: {fileInfo.Length} bytes");
            }

            // var pdfGenerator = new PdfReportGenerator();
            var pdfBytes = PdfReportGenerator.GeneratePdf(reportData, logoPath);

            // Guardar en caché temporal

            var fileName = $"Reporte_MisFinanzas_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            var fileId = FileCache.StoreFile(pdfBytes, fileName, "application/pdf");

            // Abrir URL de descarga
            var downloadUrl = $"/api/FileDownload/{fileId}";
            NavigationManager.NavigateTo(downloadUrl, forceLoad: true);

            ShowSuccessMessage("Reporte PDF generado correctamente");
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error al generar PDF: {ex.Message}");
            Console.WriteLine($"Error en GeneratePdfReport: {ex}");
        }
        finally
        {
            isGeneratingPdf = false;
            StateHasChanged();
        }
    }

    private async Task GenerateExcelReport()
    {
        try
        {
            isGeneratingExcel = true;
            StateHasChanged();

            // Validar fechas personalizadas
            if (reportPeriodType == ReportPeriodType.Custom)
            {
                if (!customStartDate.HasValue || !customEndDate.HasValue)
                {
                    ShowErrorMessage("Debes seleccionar ambas fechas para el período personalizado");
                    return;
                }

                if (customStartDate.Value > customEndDate.Value)
                {
                    ShowErrorMessage("La fecha de inicio no puede ser mayor que la fecha fin");
                    return;
                }
            }

            // Crear filtro
            var filter = new ReportFilterDto
            {
                UserId = currentUserId!,
                UserName = currentUserName ?? "Usuario",
                PeriodType = reportPeriodType,
                CustomStartDate = customStartDate,
                CustomEndDate = customEndDate,
                TransactionTypeFilter = string.IsNullOrEmpty(reportTransactionType)
                    ? null
                    : Enum.Parse<TransactionType>(reportTransactionType),
                CategoryIdFilter = reportCategoryId > 0 ? reportCategoryId : null
            };

            // Generar datos del reporte
            var reportData = await ReportService.GenerateReportDataAsync(filter);

            // Generar Excel
            var logoPath = Path.Combine(WebHostEnvironment.WebRootPath, "images", "MisFinanzas.png");
            var excelBytes = ExcelReportGenerator.GenerateExcel(reportData, logoPath);

            // Guardar en caché temporal

            var fileName = $"Reporte_MisFinanzas_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            var fileId = FileCache.StoreFile(excelBytes, fileName, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

            // Abrir URL de descarga
            var downloadUrl = $"/api/FileDownload/{fileId}";
            NavigationManager.NavigateTo(downloadUrl, forceLoad: true);

            ShowSuccessMessage("Reporte Excel generado correctamente");
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error al generar Excel: {ex.Message}");
            Console.WriteLine($"Error en GenerateExcelReport: {ex}");
        }
        finally
        {
            isGeneratingExcel = false;
            StateHasChanged();
        }
    }

    #endregion

    private void ShowSuccessMessage(string message)
    {
        successMessage = message;
        showSuccessMessage = true;
        StateHasChanged();

        successTimer?.Dispose();
        successTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                showSuccessMessage = false;
                StateHasChanged();
                System.Threading.Thread.Sleep(300);
                successMessage = string.Empty;
                StateHasChanged();
            });
        }, null, 3000, System.Threading.Timeout.Infinite);
    }

    private void ShowErrorMessage(string message)
    {
        errorMessage = message;
        showErrorMessage = true;
        StateHasChanged();

        errorTimer?.Dispose();
        errorTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                showErrorMessage = false;
                StateHasChanged();
                System.Threading.Thread.Sleep(300);
                errorMessage = string.Empty;
                StateHasChanged();
            });
        }, null, 5000, System.Threading.Timeout.Infinite);
    }

    public void Dispose()
    {
        successTimer?.Dispose();
        errorTimer?.Dispose();
    }
}