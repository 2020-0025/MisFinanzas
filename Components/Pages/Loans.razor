@page "/loans"
@rendermode InteractiveServer
@attribute [Authorize]
@using Microsoft.JSInterop
@using MisFinanzas.Infrastructure.Interfaces
@using MisFinanzas.Domain.DTOs
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using MisFinanzas.Components.Shared
@using MisFinanzas.Infrastructure.Services
@inject ILoanService LoanService
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>Préstamos - MisFinanzas</PageTitle>

<div class="loans-container">
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="mb-3 mb-md-0">
                <h1>🏦 Préstamos</h1>
                <p class="mb-0 text-white">Gestiona tus préstamos y cuotas</p>
            </div>
            <button class="btnAddLoans" id="loans-add-button" @onclick="OpenCreateModal">
                <span style="font-size: 17px;">➕</span> Nuevo Préstamo
            </button>
        </div>
    </div>

    <!-- Resumen General con estilo Dashboard -->
    <div class="row g-4 mb-4" id="loans-summary-cards">
        <!-- Total Prestado Card -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-card stat-card animate-slide-up h-100">
                <div class="stat-card-body">
                    <div class="stat-icon income-icon">
                        <span style="font-size: 32px;">📥</span>
                    </div>
                    <div class="stat-content">
                        <p class="stat-label text-white">Total Prestado</p>
                        <h2 class="stat-value text-info">@totalBorrowed.ToString("C0")</h2>
                        <small class="stat-subtitle text-white">
                            <span style="font-size: 15px;">💵</span>Recibido
                        </small>
                    </div>
                </div>
                <div class="stat-footer text-white">
                    <span style="font-size: 17px;">🏦</span>
                    Capital inicial
                </div>
            </div>
        </div>

        <!-- Deuda Pendiente Card -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-card stat-card animate-slide-up h-100" style="animation-delay: 0.1s;">
                <div class="stat-card-body">
                    <div class="stat-icon expense-icon">
                        <span style="font-size: 32px;">💰</span>
                    </div>
                    <div class="stat-content">
                        <p class="stat-label text-white">Deuda Pendiente</p>
                        <h2 class="stat-value text-danger">@totalRemaining.ToString("C0")</h2>
                        <small class="stat-subtitle text-white">
                            <span style="font-size: 15px;">📊</span>Por pagar
                        </small>
                    </div>
                </div>
                <div class="stat-footer text-white">
                    <span style="font-size: 17px;">⚠️</span>
                    Saldo actual
                </div>
            </div>
        </div>

        <!-- Cuotas Mensuales Card -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-card stat-card animate-slide-up h-100" style="animation-delay: 0.2s;">
                <div class="stat-card-body">
                    <div class="stat-icon balance-icon">
                        <span style="font-size: 32px;">📅</span>
                    </div>
                    <div class="stat-content">
                        <p class="stat-label text-white">Cuotas Mensuales</p>
                        <h2 class="stat-value text-warning">@monthlyPaymentsTotal.ToString("C0")</h2>
                        <small class="stat-subtitle text-white">
                            <span style="font-size: 15px;">📆</span>Este mes
                        </small>
                    </div>
                </div>
                <div class="stat-footer text-white">
                    <span style="font-size: 17px;">💳</span>
                    Pagos mensuales
                </div>
            </div>
        </div>

        <!-- Préstamos Activos Card -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-card stat-card animate-slide-up h-100" style="animation-delay: 0.3s;">
                <div class="stat-card-body">
                    <div class="stat-icon goals-icon">
                        <span style="font-size: 32px;">🏦</span>
                    </div>
                    <div class="stat-content">
                        <p class="stat-label text-white">Préstamos Activos</p>
                        <h2 class="stat-value text-info">@activeLoans.Count</h2>
                        <small class="stat-subtitle text-info">
                            <span style="font-size: 15px;">✅</span>En curso
                        </small>
                    </div>
                </div>
                <div class="stat-footer text-white">
                    <span style="font-size: 17px;">📋</span>
                    @(activeLoans.Count == 1 ? "Préstamo" : "Préstamos")
                </div>
            </div>
        </div>
    </div>

    <!-- Tip informativo -->
    <div class="glass-card mb-4" style="padding: 15px;">
        <p class="text-white mb-0">
            <span style="font-size: 20px;">💡</span>
            <strong>Tip:</strong> Revisa cada préstamo abajo para ver detalles de capital e interés pagados.
        </p>
    </div>


    <!-- Filtros -->
    <div class="filters-card" id="loans-filters">
        <div class="btn-group" role="group">
            <button class="text-white btn @(showActiveOnly ? "btn-primary" : "btn-outline-primary")"
                    @onclick="() => ToggleFilter(true)">
                🟢 Activos (@activeLoans.Count)
            </button>
            <button class="text-white btn @(!showActiveOnly ? "btn-secondary" : "btn-outline-secondary")"
                    @onclick="() => ToggleFilter(false)">
                📋 Todos (@allLoans.Count)
            </button>
        </div>
    </div>

    <!-- Mensajes -->
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="custom-alert error @(showErrorMessage ? "show" : "")">
            <span class="alert-icon">✕</span>
            <span class="alert-text">@errorMessage</span>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="custom-alert success @(showSuccessMessage ? "show" : "")">
            <span class="alert-icon">✓</span>
            <span class="alert-text">@successMessage</span>
        </div>
    }

    <!-- Lista de Préstamos -->
    <div class="row" id="loans-list">
        @if (isLoading)
        {
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="spinner-border text-light" role="status"></div>
                    <p class="text-white mt-3">Cargando préstamos...</p>
                </div>
            </div>
        }
        else if (!filteredLoans.Any())
        {
            <div class="col-12">
                <div class="text-center py-5">
                    <p class="text-white" style="font-size:30px;"><strong>No hay préstamos.</strong></p>
                </div>
            </div>
        }
        else
        {
            @foreach (var loan in filteredLoans)
            {
                <div class="col-lg-6 col-md-12 mb-4">
                    <div class="loan-card @(loan.IsActive ? "" : "inactive")">
                        <div class="loan-header">
                            <div class="d-flex align-items-center gap-3">
                                <div class="loan-icon">@loan.Icon</div>
                                <div class="flex-grow-1">
                                    <h4>@loan.Title</h4>
                                    @if (loan.IsActive)
                                    {
                                        <span class="text-white badge bg-success">Activo</span>
                                    }
                                    else if (loan.IsCompleted)
                                    {
                                        <span class="text-white badge bg-primary">Completado ✓</span>
                                    }
                                    else
                                    {
                                        <span class="text-white badge bg-warning">Cancelado</span>
                                    }
                                </div>
                                <div class="loan-actions">
                                    @if (loan.IsActive && !loan.IsCompleted)
                                    {
                                        <button class="btn btn-sm btn-success"
                                                id="@(filteredLoans.First() == loan ? "loans-register-payment-button" : "")"
                                                style="background-color:rgba(76, 175, 80, 0.25);"
                                                @onclick="() => RegisterPayment(loan.LoanId)" title="Registrar Pago">
                                            <span style="font-size: 13px;">💵</span>
                                        </button>
                                        @if (loan.InstallmentsPaid > 0)
                                        {
                                            <button class="btn btn-sm btn-info"
                                                    id="@(filteredLoans.First() == loan ? "loans-undo-payment-button" : "")"
                                                    style="background-color: rgba(33, 150, 243, 0.25);"
                                                    @onclick="() => UndoLastPayment(loan.LoanId)" title="Deshacer Último Pago">
                                                <span style="font-size: 13px;">↩️</span>
                                            </button>
                                        }
                                        <button class="btn btn-sm btn-warning"
                                                id="@(filteredLoans.First() == loan ? "loans-edit-button" : "")"
                                                style="background-color:rgba(255, 193, 7, 0.25);"
                                                @onclick="() => OpenEditModal(loan)" title="Editar">
                                            <span style="font-size: 13px;">📝</span>
                                        </button>
                                    }
                                    else if (!loan.IsActive && !loan.IsCompleted)
                                    {
                                        <!-- Préstamo cancelado - mostrar botón reactivar -->
                                        <button class="btn btn-sm btn-primary"
                                                id="@(filteredLoans.First() == loan ? "loans-reactivate-button" : "")"
                                                style="background-color:rgba(76, 175, 80, 0.25);"
                                                @onclick="() => ReactivateLoan(loan.LoanId)" title="Reactivar Préstamo">
                                            <span style="font-size: 13px;">🔄</span> Reactivar
                                        </button>
                                    }
                                    <button class="btn btn-sm btn-danger"
                                            id="@(filteredLoans.First() == loan ? "loans-delete-button" : "")"
                                            style="background-color:rgba(244, 67, 54, 0.25);"
                                            @onclick="() => HandleDeleteLoan(loan)"
                                            title="@(loan.IsActive ? "Eliminar" : "Eliminar del historial")">
                                        <span style="font-size: 13px;">🗑️</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(loan.Description))
                        {
                            <p class="text-white loan-description">@loan.Description</p>
                        }

                        <div class="loan-info">
                            <div class="row text-white">
                                <div class="col-6">
                                    <small class="text-white">💵 Monto Prestado:</small>
                                    <p><strong>@loan.PrincipalAmount.ToString("C")</strong></p>
                                </div>
                                <div class="col-6">
                                    <small class="text-white">📅 Cuota Mensual:</small>
                                    <p><strong>@loan.InstallmentAmount.ToString("C")</strong></p>
                                </div>
                                <div class="col-6">
                                    <small class="text-white">💰 Total a Pagar:</small>
                                    <p><strong>@loan.TotalToPay.ToString("C")</strong></p>
                                </div>
                                <div class="col-6">
                                    <small class="text-white">📈 Interés Cobrado:</small>
                                    <p>
                                        <strong class="@GetInterestColorClass(loan.InterestRateCategory)">
                                            @loan.TotalInterest.ToString("C") (@loan.ApproximateInterestRate.ToString("F2")%)
                                        </strong>
                                    </p>
                                </div>
                            </div>

                            @if (loan.ApproximateInterestRate > 30)
                            {
                                <div class="alert alert-warning py-2 mt-2">
                                    <small class="text-danger">⚠️ @loan.InterestRateLabel</small>
                                </div>
                            }
                        </div>

                        <div class="loan-progress">
                            <div class="d-flex justify-content-between mb-2 text-white">
                                <span>Progreso: @loan.InstallmentsPaid / @loan.NumberOfInstallments cuotas</span>
                                <span><strong>@loan.ProgressPercentage.ToString("F1")%</strong></span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar @GetProgressBarClass(loan.ProgressPercentage)"
                                     role="progressbar"
                                     style="width: @Math.Min(loan.ProgressPercentage, 100)%">
                                </div>
                            </div>
                        </div>

                        <div class="loan-footer text-white">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-white">🗓️ Inicio:</small>
                                    <p>@loan.StartDate.ToString("dd/MM/yyyy")</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-white">📆 Próximo Pago:</small>
                                    <p>@(loan.IsActive && !loan.IsCompleted ? loan.NextPaymentDate.ToString("dd/MM/yyyy") : "N/A")</p>
                                </div>
                            </div>
                        </div>

                        <!--  NUEVO: Botón ver tabla de amortización -->
                        <div class="mt-3 text-center">
                            <button class="btn btn-sm btn-info glass-button"
                                    style="width: 100%;"
                                    @onclick="() => ShowAmortizationTable(loan.LoanId)">
                                <span style="font-size: 13px;">📊</span> Ver Tabla de Amortización
                            </button>
                        </div>

                        <!--  NUEVO: Historial de Abonos Extras -->
                        @if (loan.ExtraPayments != null && loan.ExtraPayments.Any())
                        {
                            <div class="mt-3">
                                <div class="extra-payments-section">
                                    <h6 class="text-white mb-3">
                                        <span style="font-size: 16px;">💎</span> Historial de Abonos Extraordinarios
                                    </h6>
                                    <div class="extra-payments-list">
                                        @foreach (var payment in loan.ExtraPayments.OrderByDescending(p => p.PaidDate))
                                        {
                                            <div class="extra-payment-item glass-card p-2 mb-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <span class="text-white">
                                                            <span style="font-size: 14px;">📅</span>
                                                            @payment.PaidDate.ToString("dd/MM/yyyy")
                                                        </span>
                                                        @if (!string.IsNullOrEmpty(payment.Description))
                                                        {
                                                            <br />
                                                            <small class="text-white">@payment.Description</small>
                                                        }
                                                    </div>
                                                    <div>
                                                        <strong class="text-success">+ @payment.Amount.ToString("C")</strong>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    <div class="mt-2 text-center">
                                        <small class="text-white">
                                            <span style="font-size: 14px;">✅</span>
                                            Total abonado: <strong class="text-success">@loan.ExtraPayments.Sum(p => p.Amount).ToString("C")</strong>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        }

                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- Modal Crear/Editar Préstamo -->
@if (showModal)
{
    <div class="modal-overlay">
        <div class="modal-content-custom" @onclick:stopPropagation="true">
            <div class="modal-header-custom border-secondary">
                <h5>@(isEditMode ? "✏️ Editar préstamo" : "➕ Nuevo préstamo")</h5>
                <button class="btn-close-custom" @onclick="CloseModal">✕</button>
            </div>
            <div class="modal-body-custom">
                <EditForm Model="currentLoan" OnValidSubmit="SaveLoan">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <div style="display:flex; gap:0.4rem;">
                            <label class="form-label text-white">Título</label>
                            <label class="text-danger" style="font-size:1.1rem;"> *</label>
                        </div>
                        <InputText class="form-control glass-input" @bind-Value="currentLoan.Title" placeholder="Ej: Préstamo Personal Banco Popular" />
                        <ValidationMessage For="@(() => currentLoan.Title)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-white">Descripción</label>
                        <InputTextArea class="form-control glass-input" @bind-Value="currentLoan.Description" placeholder="Descripción opcional" rows="2" />
                        <ValidationMessage For="@(() => currentLoan.Description)" />
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div style="display:flex; gap:0.4rem;">
                                <label class="form-label text-white">Monto del préstamo</label>
                                <label class="text-danger" style="font-size:1.1rem;"> *</label>
                            </div>
                            <InputNumber class="form-control glass-input" @bind-Value="currentLoan.PrincipalAmount" @bind-Value:after="CalculatePreview" placeholder="10000" ParsingErrorMessage="Este campo es requerido" />
                            <ValidationMessage For="@(() => currentLoan.PrincipalAmount)" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <div style="display:flex; gap:0.4rem;">
                                <label class="form-label text-white">Cuota mensual</label>
                                <label class="text-danger" style="font-size:1.1rem;"> *</label>
                            </div>
                            <InputNumber class="form-control glass-input" @bind-Value="currentLoan.InstallmentAmount" @bind-Value:after="CalculatePreview" placeholder="500" ParsingErrorMessage="Este campo es requerido" />
                            <ValidationMessage For="@(() => currentLoan.InstallmentAmount)" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div style="display:flex; gap:0.4rem;">
                                <label class="form-label text-white">Cantidad de Cuotas</label>
                                <label class="text-danger" style="font-size:1.1rem;"> *</label>
                            </div>
                            <InputNumber class="form-control glass-input" @bind-Value="currentLoan.NumberOfInstallments" @bind-Value:after="CalculatePreview" placeholder="12" ParsingErrorMessage="Este campo es requerido" />
                            <ValidationMessage For="@(() => currentLoan.NumberOfInstallments)" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <div style="display:flex; gap:0.4rem;">
                                <label class="form-label text-white">Día de Pago (1-31)</label>
                                <label class="text-danger" style="font-size:1.1rem;"> *</label>
                            </div>
                            <InputNumber class="form-control glass-input" @bind-Value="currentLoan.DueDay" placeholder="15" ParsingErrorMessage="Este campo es requerido" />
                            <ValidationMessage For="@(() => currentLoan.DueDay)" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <div style="display:flex; gap:0.4rem;">
                            <label class="form-label text-white">Fecha de Inicio</label>
                            <label class="text-danger" style="font-size:1.1rem;"> *</label>
                        </div>
                        <InputDate class="form-control glass-input" @bind-Value="currentLoan.StartDate" />
                        <ValidationMessage For="@(() => currentLoan.StartDate)" />
                    </div>

                    <div class="mb-3 text-white">
                        <IconSelector @bind-SelectedIcon="currentLoan.Icon" Label="Icono" />
                    </div>

                    <!--  NUEVO: Campo de tasa de interés -->
                    <div class="mb-3">
                        <div style="display:flex; gap:0.4rem;">
                            <label class="form-label text-white">Tasa de interés anual (%)</label>
                        </div>
                        <div class="input-group">
                            <InputNumber @bind-Value="currentLoan.InterestRate"
                                         @bind-Value:after="CalculatePreview"
                                         class="form-control glass-input"
                                         placeholder="18.5"
                                         min="0"
                                         max="100"
                                         step="0.01"
                                         disabled="@useApproximateRate"
                                         style="@(useApproximateRate ? "background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; color: white !important; opacity: 0.7;" : "")" />
                            <span class="input-group-text" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white;">%</span>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input"
                                   type="checkbox"
                                   @bind="useApproximateRate"
                                   @bind:after="CalculatePreview"
                                   id="useApproximateRate">
                            <label class="form-check-label text-white" for="useApproximateRate">
                                ❓ No conozco mi tasa, calcular aproximada
                            </label>
                        </div>
                        @if (useApproximateRate && approximateRate > 0)
                        {
                            <small class="form-text text-warning">
                                ⚠️ Tasa aproximada: <strong>@approximateRate.ToString("F2")%</strong> (puede no ser exacta)
                            </small>
                        }
                    </div>



                    @if (!isEditMode)
                    {
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="createReminder" id="createReminderCheck">
                                <label class="form-check-label text-white" for="createReminderCheck">
                                    🔔 Crear recordatorio mensual
                                </label>
                            </div>
                        </div>
                    }

                    <!-- Vista Previa -->
                    @if (previewTotalToPay > 0)
                    {
                        <div class="preview-card">
                            <h6 class="text-white">💡 Vista previa</h6>
                            <div class="preview-info">
                                <div class="d-flex justify-content-between">
                                    <span>Total a pagar:</span>
                                    <strong>@previewTotalToPay.ToString("C")</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Interés total:</span>
                                    <strong class="@GetInterestColorClass(previewInterestCategory)">
                                        @previewInterest.ToString("C")
                                    </strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Tasa aproximada:</span>
                                    <strong class="@GetInterestColorClass(previewInterestCategory)">
                                        @previewInterestRate.ToString("F2")%
                                    </strong>
                                </div>
                                <div class="mt-2">
                                    <small class="@GetInterestColorClass(previewInterestCategory)">
                                        @previewInterestLabel
                                    </small>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="modal-footer-custom">
                        <button type="submit" class=" btn btnSaveEdit">
                            @(isEditMode ? "Actualizar" : "Crear")
                        </button>
                        <button type="button" class="btn btnCancel" @onclick="CloseModal">Cancelar</button>

                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- Modal Eliminar -->
@if (showDeleteModal)
{
    <div class="modal-overlay">
        <div class="modal-content-custom modal-delete" @onclick:stopPropagation="true">
            <div class="modal-header-custom">
                <h5>🗑️ Eliminar préstamo</h5>
                <button class="btn-close-custom" @onclick="CloseDeleteModal">✕</button>
            </div>
            <div class="modal-body-custom">
                <p class="text-white">¿Estás seguro de eliminar este préstamo <strong>activo</strong>?</p>
                <div class="alert alert-info">
                    <strong>@loanToDelete?.Icon @loanToDelete?.Title</strong>
                    <p class="mb-0 mt-2">Este préstamo tiene @loanToDelete?.InstallmentsPaid pagos registrados</p>
                </div>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" @bind="deleteHistory" id="deleteHistoryCheck">
                    <label class="form-check-label text-white" for="deleteHistoryCheck">
                        <strong>Eliminar también el historial de pagos</strong>
                    </label>
                </div>

                @if (deleteHistory)
                {
                    <div class="alert alert-danger mt-3">
                        <strong>⚠️ Esta acción NO se puede deshacer.</strong>
                        <p class="mb-0">Se eliminarán:</p>
                        <ul class="mb-0">
                            <li>La categoría del préstamo</li>
                            <li>Los @loanToDelete?.InstallmentsPaid pagos registrados</li>
                            <li>El préstamo completo</li>
                        </ul>
                    </div>
                }
            </div>
            <div class="modal-footer-custom mb-4" style="margin-right:20px;">
                <button class="btn btnCancel" @onclick="CloseDeleteModal">Cancelar</button>
                <button class="btn btnDelete" @onclick="ConfirmDelete">Eliminar</button>
            </div>
        </div>
    </div>
}


<!-- Modal Tabla de Amortización -->
@if (showAmortizationModal && selectedLoanForTable != null)
{
    <div class="modal-overlay">
        <div class="modal-content-amortization border-primary" @onclick:stopPropagation="true">
            <div class="modal-header-custom border-secondary">
                <h5>📊 Tabla de Amortización - @selectedLoanForTable.Icon @selectedLoanForTable.Title</h5>
                <button class="btn-close-custom" @onclick="CloseAmortizationTable">✕</button>
            </div>
            <div class="modal-body-custom" style="max-height: 70vh; overflow-y: auto;">

                <div class="glass-card mb-3 p-3 border-primary" style="background: rgba(0, 0, 0, 0.5) !important;">
                    <div class="row text-white">
                        <div class="col-md-3">
                            <small>💵 Monto:</small>
                            <p class="mb-0"><strong>@selectedLoanForTable.PrincipalAmount.ToString("C")</strong></p>
                        </div>
                        <div class="col-md-3">
                            <small>📈 Tasa:</small>
                            <p class="mb-0"><strong>@(selectedLoanForTable.InterestRate?.ToString("F2") ?? selectedLoanForTable.ApproximateInterestRate.ToString("F2"))% anual</strong></p>
                        </div>
                        <div class="col-md-3">
                            <small>📅 Cuotas:</small>
                            <p class="mb-0"><strong>@selectedLoanForTable.NumberOfInstallments de @selectedLoanForTable.InstallmentAmount.ToString("C")</strong></p>
                        </div>
                        <div class="col-md-3">
                            <small>💰 Total:</small>
                            <p class="mb-0"><strong>@selectedLoanForTable.TotalToPay.ToString("C")</strong></p>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-dark">
                        <thead>
                            <tr class="text-white">
                                <th style="width: 5%;">#</th>
                                <th style="width: 13%;">Fecha</th>
                                <th style="width: 16%;">Capital</th>
                                <th style="width: 16%;">Interés</th>
                                <th style="width: 16%;">Total</th>
                                <th style="width: 16%;">Saldo</th>
                                <th style="width: 8%;">Estado</th>
                                <th style="width: 10%;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var installment in selectedLoanForTable.Installments.OrderBy(i => i.InstallmentNumber))
                            {
                                var isNext = !installment.IsPaid && (selectedLoanForTable.Installments.Where(i => !i.IsPaid).OrderBy(i => i.InstallmentNumber).FirstOrDefault()?.InstallmentNumber == installment.InstallmentNumber);

                                <tr class="@(installment.IsRecalculated ? "recalculated-row" : "")">
                                    <td>@installment.InstallmentNumber</td>
                                    <td>@installment.DueDate.ToString("dd/MM/yyyy")</td>
                                    <td class="text-info">@installment.PrincipalAmount.ToString("C")</td>
                                    <td class="text-danger">@installment.InterestAmount.ToString("C")</td>
                                    <td class="text-white"><strong>@installment.TotalAmount.ToString("C")</strong></td>
                                    <td class="text-warning">@installment.RemainingBalance.ToString("C")</td>
                                    <td class="text-center">
                                        @if (installment.IsPaid)
                                        {
                                            <span title="Pagada">✅</span>
                                        }
                                        else if (isNext)
                                        {
                                            <span title="Próxima">⏳</span>
                                        }
                                        else
                                        {
                                            <span title="Pendiente">⏸️</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (installment.IsRecalculated)
                                        {
                                            <span title="Recalculada el @installment.RecalculatedDate?.ToString("dd/MM/yyyy")"
                                                  style="font-size: 16px; cursor: help;">
                                                🔄
                                            </span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- NUEVO: Resumen de Abonos Extras -->
                @if (selectedLoanForTable.ExtraPayments != null && selectedLoanForTable.ExtraPayments.Any())
                {
                    <div class="glass-card mt-3 p-3 border-success" style="background: rgba(0, 100, 0, 0.15) !important;">
                        <h6 class="text-white mb-3">
                            <span style="font-size: 18px;">💎</span> Abonos Extraordinarios
                        </h6>
                        <div class="row text-white">
                            <div class="col-md-6">
                                <p><strong>📅 Total de abonos realizados:</strong> @selectedLoanForTable.ExtraPayments.Count</p>
                                <p>
                                    <strong>💰 Monto total abonado:</strong>
                                    <span class="text-success">@selectedLoanForTable.ExtraPayments.Sum(p => p.Amount).ToString("C")</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p>
                                    <strong>🔄 Cuotas recalculadas:</strong>
                                    @selectedLoanForTable.Installments.Count(i => i.IsRecalculated)
                                </p>
                                <p>
                                    <strong>✅ Beneficio:</strong>
                                    <span class="text-success">Reducción de intereses en cuotas futuras</span>
                                </p>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-white">
                                <span style="font-size: 14px;">💡</span>
                                Los abonos extras se aplicaron directamente al capital, reduciendo el saldo y recalculando las cuotas pendientes.
                            </small>
                        </div>
                    </div>
                }

                <div class="glass-card mt-3 p-3 border-primary" style="background: rgba(0, 0, 0, 0.5) !important;">
                    <h6 class="text-white mb-3">📋 Resumen</h6>
                    <div class="row text-white">
                        <div class="col-md-6">
                            <p><strong>✅ Cuotas pagadas:</strong> @selectedLoanForTable.InstallmentsPaid</p>
                            <p><strong>💰 Capital pagado:</strong> @selectedLoanForTable.Installments.Where(i => i.IsPaid).Sum(i => i.PrincipalAmount).ToString("C")</p>
                            <p><strong>📈 Interés pagado:</strong> @selectedLoanForTable.Installments.Where(i => i.IsPaid).Sum(i => i.InterestAmount).ToString("C")</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>⏸️ Cuotas pendientes:</strong> @selectedLoanForTable.RemainingInstallments</p>
                            <p><strong>💵 Saldo por pagar:</strong> @((selectedLoanForTable.TotalToPay - selectedLoanForTable.TotalPaid).ToString("C"))</p>
                            <p><strong>📊 Progreso:</strong> @selectedLoanForTable.ProgressPercentage.ToString("F1")%</p>
                        </div>
                    </div>
                </div>

                <!-- NUEVO: Leyenda de indicadores -->
                @if (selectedLoanForTable.Installments.Any(i => i.IsRecalculated))
                {
                    <div class="glass-card mt-3 p-2 border-info" style="background: rgba(0, 50, 100, 0.15) !important;">
                        <div class="text-white text-center">
                            <small>
                                <span style="font-size: 14px;">ℹ️</span>
                                Las cuotas marcadas con <span style="font-size: 16px;">🔄</span> fueron recalculadas después de un abono extraordinario.
                            </small>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer-custom">
                <button class="btn btnCancel" @onclick="CloseAmortizationTable">Cerrar</button>
            </div>
        </div>
    </div>
}

<!-- Modal Pago con Abono Extra -->
@if (showPaymentModal && selectedLoanForPayment != null)
{
    <div class="modal-overlay">
        <div class="modal-content-custom modal-payment" @onclick:stopPropagation="true">
            <div class="modal-header-custom border-secondary">
                <h5 class="text-white"><span style="font-size: 20px;">💵</span> Registrar Pago</h5>
                <button class="btn-close-custom" @onclick="ClosePaymentModal">✕</button>
            </div>
            <div class="modal-body-custom">
                <div class="payment-info mb-4">
                    <h6 class="text-white mb-3">📋 Información del Préstamo</h6>
                    <p class="text-white mb-2"><strong>@selectedLoanForPayment.Icon @selectedLoanForPayment.Title</strong></p>
                    <p class="text-white mb-2">Cuota: <strong class="text-info">@selectedLoanForPayment.InstallmentAmount.ToString("C")</strong></p>
                    <p class="text-white mb-0">Progreso: <strong>@selectedLoanForPayment.InstallmentsPaid / @selectedLoanForPayment.NumberOfInstallments cuotas</strong></p>
                </div>

                <hr class="border-secondary" />

                <!-- Sección Abono Extra -->
                <div class="extra-payment-section mb-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="includeExtraPayment"
                               @bind="includeExtraPayment">
                        <label class="form-check-label text-white" for="includeExtraPayment">
                            <span style="font-size: 16px;">➕</span> ¿Deseas hacer un abono extra al capital?
                        </label>
                    </div>

                    @if (includeExtraPayment)
                    {
                        <div class="extra-payment-input">
                            <label class="form-label text-white">Monto del Abono Extra:</label>
                            <InputNumber class="form-control glass-input" @bind-Value="extraPaymentAmount"
                                         placeholder="0.00" min="0" step="100" />
                            <small class="form-text text-white">
                                <span style="font-size: 14px;">💡</span> El abono se aplicará directamente al capital, reduciendo los intereses futuros.
                            </small>
                        </div>
                    }
                </div>

                <!-- Resumen del Pago -->
                <div class="payment-summary glass-card p-3">
                    <h6 class="text-white mb-3">📊 Resumen del Pago</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-white">Cuota Regular:</span>
                        <strong class="text-info">@currentInstallmentAmount.ToString("C")</strong>
                    </div>
                    @if (includeExtraPayment && extraPaymentAmount > 0)
                    {
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-white">Abono Extra:</span>
                            <strong class="text-success">+ @extraPaymentAmount.ToString("C")</strong>
                        </div>
                        <hr class="border-secondary" />
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-white"><strong>Total a Pagar:</strong></span>
                            <strong class="text-warning">@((currentInstallmentAmount + extraPaymentAmount).ToString("C"))</strong>
                        </div>
                        <div class="alert alert-success mt-3 mb-0" style="background-color: rgba(76, 175, 80, 0.2); border-color: rgba(76, 175, 80, 0.4);">
                            <small class="text-white">
                                <span style="font-size: 14px;">✅</span> Este abono reducirá tus intereses futuros y puede acortar el plazo del préstamo.
                            </small>
                        </div>
                    }
                    else
                    {
                        <hr class="border-secondary" />
                        <div class="d-flex justify-content-between">
                            <span class="text-white"><strong>Total a Pagar:</strong></span>
                            <strong class="text-warning">@currentInstallmentAmount.ToString("C")</strong>
                        </div>
                    }
                </div>
            </div>
            <div class="modal-payment-footer-custom">
                <button class="btn btnCancel" @onclick="ClosePaymentModal">Cancelar</button>
                <button class="btn btnPrimary" @onclick="ConfirmPayment">
                    <span style="font-size: 15px;">💳</span> Confirmar Pago
                </button>
            </div>
        </div>
    </div>
}


<FloatingHelpButton OnClick="StartTour" Icono="?" Titulo="Ayuda" Bottom="90" />

<FloatingHelpButton OnClick="GotoHome" Icono="🏠" Titulo="Ir al Inicio" Bottom="140" />

@code {
    private string currentUserId = string.Empty;
    private List<LoanDto> allLoans = new();
    private List<LoanDto> activeLoans = new();
    private List<LoanDto> filteredLoans = new();
    private bool showActiveOnly = true;
    private bool isLoading = true;

    // Resumen
    private decimal totalBorrowed = 0;
    private decimal totalToPay = 0;
    private decimal totalPaid = 0;
    private decimal totalRemaining = 0;
    private decimal monthlyPaymentsTotal = 0;
    private decimal averageInterestRate = 0;

    // Modales
    private bool showModal = false;
    private bool showDeleteModal = false;
    private bool isEditMode = false;
    private LoanDto currentLoan = new();
    private LoanDto? loanToDelete;
    private bool deleteHistory = false;
    private bool createReminder = false;


    // NUEVAS VARIABLES PARA TASA
    private bool useApproximateRate = false;
    private decimal approximateRate = 0;

    // Vista previa
    private decimal previewTotalToPay = 0;
    private decimal previewInterest = 0;
    private decimal previewInterestRate = 0;
    private string previewInterestCategory = "";
    private string previewInterestLabel = "";

    // Mensajes
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool showSuccessMessage = false;
    private bool showErrorMessage = false;
    private System.Threading.Timer? successTimer;
    private System.Threading.Timer? errorTimer;

    //  NUEVO: Variables para modal de amortización
    private bool showAmortizationModal = false;
    private LoanDto? selectedLoanForTable = null;

    //  NUEVO: Variables para modal de pago con abono extra
    private bool showPaymentModal = false;
    private LoanDto? selectedLoanForPayment = null;
    private bool includeExtraPayment = false;
    private decimal extraPaymentAmount = 0;
    private decimal currentInstallmentAmount = 0;


    //Tour automático
    private bool _tourLaunched = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            currentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
            await LoadLoans();
            await LoadSummary();
        }

        isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_tourLaunched)
        {
            // NUEVO: Iniciar tour automáticamente si es primera vez
            _tourLaunched = true;
            await Task.Delay(500); // Pequeño delay para que cargue la UI
            await JSRuntime.InvokeVoidAsync("tourService.startTourIfFirstTime", "loans");
        }
    }

    //Botones flotantes
    private async Task StartTour()
    {
        await JSRuntime.InvokeVoidAsync("tourService.startLoansTour");
    }
    // Lógica para redirigir
    private void GotoHome()
    {
        NavigationManager.NavigateTo("/"); // Redirige al Home
    }

    private async Task LoadLoans()
    {
        try
        {
            isLoading = true;

            if (string.IsNullOrEmpty(currentUserId))
                return;

            allLoans = await LoanService.GetAllByUserAsync(currentUserId);
            activeLoans = allLoans.Where(l => l.IsActive).ToList();
            ApplyFilter();
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error al cargar préstamos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadSummary()
    {
        try
        {
            if (string.IsNullOrEmpty(currentUserId))
                return;

            totalBorrowed = await LoanService.GetTotalBorrowedAsync(currentUserId);
            totalToPay = await LoanService.GetTotalToPayAsync(currentUserId);
            totalPaid = await LoanService.GetTotalPaidAsync(currentUserId);
            totalRemaining = await LoanService.GetTotalRemainingAsync(currentUserId);
            monthlyPaymentsTotal = await LoanService.GetMonthlyPaymentsTotalAsync(currentUserId);
            averageInterestRate = await LoanService.GetAverageInterestRateAsync(currentUserId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar resumen: {ex.Message}");
        }
    }

    private void ToggleFilter(bool activeOnly)
    {
        showActiveOnly = activeOnly;
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        filteredLoans = showActiveOnly ? activeLoans : allLoans;
    }

    // ========== CRUD ==========

    private void OpenCreateModal()
    {
        isEditMode = false;
        currentLoan = new LoanDto
        {
            StartDate = DateTime.Now,
            Icon = "🏦",
            PrincipalAmount = 0,
            InstallmentAmount = 0,
            NumberOfInstallments = 12,
            DueDay = DateTime.Now.Day
        };

        //  RESET VARIABLES
        useApproximateRate = false;
        approximateRate = 0;
        createReminder = false;

        previewTotalToPay = 0;
        previewInterest = 0;
        previewInterestRate = 0;
        showModal = true;
    }

    private void OpenEditModal(LoanDto loan)
    {
        isEditMode = true;
        currentLoan = new LoanDto
        {
            LoanId = loan.LoanId,
            Title = loan.Title,
            Description = loan.Description,
            PrincipalAmount = loan.PrincipalAmount,
            InstallmentAmount = loan.InstallmentAmount,
            NumberOfInstallments = loan.NumberOfInstallments,
            DueDay = loan.DueDay,
            StartDate = loan.StartDate,
            Icon = loan.Icon,
            CategoryId = loan.CategoryId,
            InstallmentsPaid = loan.InstallmentsPaid
        };
        CalculatePreview();
        showModal = true;
    }

    private async Task SaveLoan()
    {
        try
        {
            if (string.IsNullOrEmpty(currentUserId))
            {
                ShowErrorMessage("Error: No se pudo identificar el usuario");
                return;
            }

            if (isEditMode)
            {
                var success = await LoanService.UpdateAsync(currentLoan.LoanId, currentLoan, currentUserId);

                if (success)
                {
                    ShowSuccessMessage("Préstamo actualizado correctamente");
                    await LoadLoans();
                    await LoadSummary();
                    CloseModal();
                }
                else
                {
                    ShowErrorMessage("No se pudo actualizar el préstamo");
                }
            }
            else
            {
                var result = await LoanService.CreateAsync(currentLoan, currentUserId, createReminder);

                if (result.Success && result.Loan != null)
                {
                    ShowSuccessMessage("Préstamo creado correctamente");
                    await LoadLoans();
                    await LoadSummary();
                    CloseModal();
                }
                else
                {
                    ShowErrorMessage($"Error al crear préstamo: {result.Error ?? "Error desconocido"}");
                }
            }
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error: {ex.Message}");
        }
    }

    private void HandleDeleteLoan(LoanDto loan)
    {
        if (!loan.IsActive)
        {
            // Préstamo en historial - eliminar directamente con TODO el historial
            DeleteLoanFromHistory(loan);
        }
        else
        {
            // Préstamo activo - mostrar modal con opciones
            OpenDeleteModal(loan);
        }
    }

    private void OpenDeleteModal(LoanDto loan)
    {
        loanToDelete = loan;
        deleteHistory = false;
        showDeleteModal = true;
    }

    private async void DeleteLoanFromHistory(LoanDto loan)
    {
        // Confirmación simple sin modal
        loanToDelete = loan;
        deleteHistory = true;
        await ConfirmDelete();
    }

    private async Task ConfirmDelete()
    {
        try
        {
            if (loanToDelete == null || string.IsNullOrEmpty(currentUserId))
                return;

            var success = await LoanService.DeleteAsync(loanToDelete.LoanId, currentUserId, deleteHistory);
            if (success)
            {
                ShowSuccessMessage("Préstamo eliminado correctamente");
                await LoadLoans();
                await LoadSummary();
                CloseDeleteModal();
            }
            else
            {
                ShowErrorMessage("Error al eliminar el préstamo");
            }
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error: {ex.Message}");
        }
    }

    private void RegisterPayment(int loanId)
    {
        try
        {
            if (string.IsNullOrEmpty(currentUserId))
                return;

            // Buscar el préstamo seleccionado
            var loan = allLoans.FirstOrDefault(l => l.LoanId == loanId);
            if (loan == null)
                return;

            // Configurar variables del modal
            selectedLoanForPayment = loan;
            currentInstallmentAmount = loan.InstallmentAmount;
            includeExtraPayment = false;
            extraPaymentAmount = 0;

            // Abrir modal
            showPaymentModal = true;
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error: {ex.Message}");
        }
    }

    private async Task ConfirmPayment()
    {
        try
        {
            if (string.IsNullOrEmpty(currentUserId) || selectedLoanForPayment == null)
                return;

            // 1. Registrar pago normal de la cuota
            var paymentSuccess = await LoanService.RegisterPaymentAsync(selectedLoanForPayment.LoanId, currentUserId);

            if (!paymentSuccess)
            {
                ShowErrorMessage("Error al registrar el pago de la cuota");
                return;
            }

            // 2. Si hay abono extra, procesarlo
            if (includeExtraPayment && extraPaymentAmount > 0)
            {
                var (extraSuccess, extraError) = await LoanService.RegisterExtraPaymentAsync(
                    selectedLoanForPayment.LoanId,
                    extraPaymentAmount,
                    currentUserId);

                if (!extraSuccess)
                {
                    ShowErrorMessage($"Cuota registrada, pero error en abono extra: {extraError}");
                }
                else
                {
                    ShowSuccessMessage($"Pago registrado con éxito. Abono extra de {extraPaymentAmount:C} aplicado.");
                }
            }
            else
            {
                ShowSuccessMessage("Pago registrado correctamente");
            }

            // Cerrar modal y recargar
            ClosePaymentModal();
            await LoadLoans();
            await LoadSummary();
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error: {ex.Message}");
        }
    }

    private void ClosePaymentModal()
    {
        showPaymentModal = false;
        selectedLoanForPayment = null;
        includeExtraPayment = false;
        extraPaymentAmount = 0;
    }

    private async Task UndoLastPayment(int loanId)
    {
        try
        {
            if (string.IsNullOrEmpty(currentUserId))
                return;

            var success = await LoanService.UndoLastPaymentAsync(loanId, currentUserId);
            if (success)
            {
                ShowSuccessMessage("Pago deshecho correctamente");
                await LoadLoans();
                await LoadSummary();
            }
            else
            {
                ShowErrorMessage("Error al deshacer el pago");
            }
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error: {ex.Message}");
        }
    }

    private async Task ReactivateLoan(int loanId)
    {
        try
        {
            if (string.IsNullOrEmpty(currentUserId))
                return;

            var success = await LoanService.ReactivateLoanAsync(loanId, currentUserId);
            if (success)
            {
                ShowSuccessMessage("Préstamo reactivado correctamente");
                await LoadLoans();
                await LoadSummary();
            }
            else
            {
                ShowErrorMessage("No se pudo reactivar el préstamo");
            }
        }
        catch (Exception ex)
        {
            ShowErrorMessage($"Error: {ex.Message}");
        }
    }

    // ========== VISTA PREVIA ==========

    private void CalculatePreview()
    {
        if (currentLoan.PrincipalAmount > 0 && currentLoan.InstallmentAmount > 0 && currentLoan.NumberOfInstallments > 0)
        {
            // Calcular o usar tasa
            decimal rate;
            if (useApproximateRate)
            {
                rate = LoanAmortizationHelper.CalculateApproximateInterestRate(
                    currentLoan.PrincipalAmount,
                    currentLoan.InstallmentAmount,
                    currentLoan.NumberOfInstallments);
                approximateRate = rate;
                currentLoan.InterestRate = null; // No guardar tasa aproximada
            }
            else
            {
                rate = currentLoan.InterestRate ?? 0;
                approximateRate = 0;
            }

            previewTotalToPay = currentLoan.InstallmentAmount * currentLoan.NumberOfInstallments;
            previewInterest = previewTotalToPay - currentLoan.PrincipalAmount;
            previewInterestRate = rate;

            // Clasificación
            if (rate <= 15)
            {
                previewInterestCategory = "favorable";
                previewInterestLabel = "✅ Tasa favorable - Buen préstamo";
            }
            else if (rate <= 30)
            {
                previewInterestCategory = "moderada";
                previewInterestLabel = "⚠️ Tasa moderada - Aceptable";
            }
            else
            {
                previewInterestCategory = "alta";
                previewInterestLabel = "🚨 Tasa alta - Considera refinanciar";
            }
        }
        else
        {
            previewTotalToPay = 0;
            previewInterest = 0;
            previewInterestRate = 0;
            previewInterestCategory = "";
            previewInterestLabel = "";
        }
    }


    private void ResetPreview()
    {
        previewTotalToPay = 0;
        previewInterest = 0;
        previewInterestRate = 0;
        previewInterestCategory = "";
        previewInterestLabel = "";
    }

    // ========== UI HELPERS ==========

    private string GetProgressBarClass(decimal percentage)
    {
        if (percentage >= 100) return "bg-success";
        if (percentage >= 75) return "bg-info";
        if (percentage >= 50) return "bg-warning";
        return "bg-danger";
    }

    private string GetInterestColorClass(string category)
    {
        return category switch
        {
            "favorable" => "text-success",
            "moderada" => "text-warning",
            "alta" => "text-danger",
            _ => "text-white"
        };
    }

    private void CloseModal()
    {
        showModal = false;
        currentLoan = new LoanDto();
        ResetPreview();
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        loanToDelete = null;
        deleteHistory = false;
    }

    // ========== MENSAJES ==========

    private void ShowSuccessMessage(string message)
    {
        successMessage = message;
        showSuccessMessage = true;
        StateHasChanged();

        successTimer?.Dispose();
        successTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                showSuccessMessage = false;
                StateHasChanged();
                System.Threading.Thread.Sleep(300);
                successMessage = string.Empty;
                StateHasChanged();
            });
        }, null, 3000, System.Threading.Timeout.Infinite);
    }

    private void ShowErrorMessage(string message)
    {
        errorMessage = message;
        showErrorMessage = true;
        StateHasChanged();

        errorTimer?.Dispose();
        errorTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                showErrorMessage = false;
                StateHasChanged();
                System.Threading.Thread.Sleep(300);
                errorMessage = string.Empty;
                StateHasChanged();
            });
        }, null, 5000, System.Threading.Timeout.Infinite);
    }

    public void Dispose()
    {
        successTimer?.Dispose();
        errorTimer?.Dispose();
    }

    //  NUEVOS MÉTODOS PARA TABLA DE AMORTIZACIÓN
    private async Task ShowAmortizationTable(int loanId)
    {
        var loan = await LoanService.GetByIdAsync(loanId, currentUserId);
        if (loan != null)
        {
            selectedLoanForTable = loan;
            showAmortizationModal = true;
        }
    }

    private void CloseAmortizationTable()
    {
        showAmortizationModal = false;
        selectedLoanForTable = null;
    }
}