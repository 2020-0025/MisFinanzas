@page "/dashboard"
@rendermode InteractiveServer
@attribute [Authorize]
@using MisFinanzas.Domain.DTOs
@using MisFinanzas.Domain.Enums
@using MisFinanzas.Infrastructure.Interfaces
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject IExpenseIncomeService ExpenseIncomeService
@inject ICategoryService CategoryService
@inject IFinancialGoalService GoalService
@inject IBudgetService BudgetService
@inject ILoanService LoanService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Panel de Control - Mis Finanzas</PageTitle>

<div class="dashboard-container">
    @if (isLoading)
    {
        <div class="glass-card text-center py-5 animate-slide-up">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="text-white-50 mt-3 mb-0">Cargando tus datos financieros...</p>
        </div>
    }
    else
    {
        <!-- Header con efecto glass -->
        <div class="glass-card dashboard-header animate-slide-up">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="h3 mb-1 text-white fw-bold">
                        <span style="font-size: 32px;">📊</span>
                        <strong>Panel de Control</strong>
                    </h1>
                    <p class="text-white mb-0">Resumen de tus finanzas</p>
                </div>
                <div class="glass-badge">
                    <span style="font-size: 17px;">📅</span>
                    <span class="text-white">Últimos @selectedDays días</span>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-5 g-4 mb-4" id="dashboard-summary-cards">
            <!-- Balance Card -->
            <div class="col">
                <div class="glass-card stat-card animate-slide-up h-100">
                    <div class="stat-card-body">
                        <div class="stat-icon balance-icon">
                            <span style="font-size: 32px;">💰</span>
                        </div>
                        <div class="stat-content">
                            <p class="stat-label text-white">Balance</p>
                            <h2 class="stat-value @(balance >= 0 ? "text-info" : "text-danger")">
                                @if (balance >= 0)
                                {
                                    <text>@balance.ToString("C0")</text>
                                }
                                else
                                {
                                    <text>-@Math.Abs(balance).ToString("C0")</text>
                                }
                            </h2>
                            <small class="stat-subtitle @(balance >= 0 ? "text-info" : "text-danger")">
                                <span style="font-size: 15px;">@(balance >= 0 ? "✅" : "⚠️")</span>
                                @(balance >= 0 ? "Superávit" : "Déficit")
                            </small>
                        </div>
                    </div>
                    <div class="stat-footer text-white">
                        <span style="font-size: 17px;">💲</span>
                        @if (balance >= 0)
                        {
                            <text>Situación positiva</text>
                        }
                        else
                        {
                            <text>Gastos exceden ingresos</text>
                        }
                    </div>
                </div>
            </div>

            <!-- Income Card -->
            <div class="col">
                <div class="glass-card stat-card animate-slide-up h-100" style="animation-delay: 0.1s;">
                    <div class="stat-card-body">
                        <div class="stat-icon income-icon">
                            <span style="font-size: 32px;">📈</span>
                        </div>
                        <div class="stat-content">
                            <p class="stat-label text-white">Ingresos</p>
                            <h2 class="stat-value text-success">@totalIncome.ToString("C0")</h2>
                            <small class="stat-subtitle text-white">
                                <span style="font-size: 15px;">🔼</span>Entradas
                            </small>
                        </div>
                    </div>
                    <div class="stat-footer text-white">
                        <span style="font-size: 17px;">💵</span>
                        Total recibido
                    </div>
                </div>
            </div>
            <!-- Loan Card -->
            <div class="col">
                <div class="glass-card stat-card animate-slide-up h-100" style="animation-delay: 0.05s;">
                    <div class="stat-card-body">
                        <div class="stat-icon loan-icon" style="background: rgba(253, 126, 20, 0.2); color: #fd7e14;">
                            <span style="font-size: 32px;">🏦</span>
                        </div>
                        <div class="stat-content">
                            <p class="stat-label text-white">Deuda Total</p>

                            <h2 class="stat-value text-warning">@totalDebt.ToString("C0")</h2>

                            <small class="stat-subtitle text-white text-start d-block">
                                <span style="font-size: 15px;">📉</span> Compromiso Total
                            </small>
                        </div>
                    </div>

                    <div class="stat-footer text-white">
                        <div class="d-flex flex-column">
                            <span style="font-size: 0.9rem;">
                                Capital: <strong class="text-info">@totalOriginalAmount.ToString("C0")</strong>
                            </span>
                            <span style="font-size: 0.75rem;">
                                @activeLoansCount préstamos activos
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expense Card -->
            <div class="col">
                <div class="glass-card stat-card animate-slide-up h-100" style="animation-delay: 0.2s;">
                    <div class="stat-card-body">
                        <div class="stat-icon expense-icon">
                            <span style="font-size: 32px;">📉</span>
                        </div>
                        <div class="stat-content">
                            <p class="stat-label text-white">Gastos</p>
                            <h2 class="stat-value text-danger">@totalExpense.ToString("C0")</h2>
                            <small class="stat-subtitle text-white">
                                <span style="font-size: 15px;">🔽</span>Salidas
                            </small>
                        </div>
                    </div>
                    <div class="stat-footer text-white">
                        <span style="font-size: 17px;">🛒</span>
                        Total gastado
                    </div>
                </div>
            </div>

            <!-- Goals Card -->
            <div class="col">
                <div class="glass-card stat-card animate-slide-up h-100" style="animation-delay: 0.3s;">
                    <div class="stat-card-body">
                        <div class="stat-icon goals-icon">
                            <span style="font-size: 32px;">🎯</span>
                        </div>
                        <div class="stat-content">
                            <p class="stat-label text-white">Metas</p>
                            <h2 class="stat-value text-info">@completedGoalsCount/@totalGoalsCount</h2>
                            <small class="stat-subtitle text-info">
                                <span style="font-size: 15px;">🚩</span>Completadas
                            </small>
                        </div>
                    </div>
                    <div class="stat-footer text-white">
                        @if (totalGoalsCount > 0)
                        {
                            var percentage = (completedGoalsCount * 100.0 / totalGoalsCount).ToString("F0");
                            <span>
                                <span style="font-size: 17px;">🏆</span>
                                @percentage% progreso
                            </span>
                        }
                        else
                        {
                            <span>
                                <span style="font-size: 17px;">🚀</span>
                                Crea una meta
                            </span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Charts Row -->
        <div class="row g-4 mb-4" id="dashboard-income-expense-chart">
            <!-- Bar Chart -->
            <div class="col-lg-12">
                <div class="glass-card h-100 animate-slide-up" style="animation-delay: 0.4s;">
                    <div class="card-header-glass">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h5 class="mb-0 text-white fw-semibold">
                                <span style="font-size: 20px;">📊</span>
                                Ingresos vs Gastos
                            </h5>
                            <div class="btn-group btn-group-sm" id="dashboard-period-selector" role="group">
                                <button type="button"
                                        class="glass-btn text-white @(selectedDays == 7 ? "active" : "")"
                                        @onclick="() => ChangePeriod(7)">
                                    7 días
                                </button>
                                <button type="button"
                                        class="glass-btn text-white @(selectedDays == 30 ? "active" : "")"
                                        @onclick="() => ChangePeriod(30)">
                                    30 días
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body-glass">
                        @if (chartData.Any())
                        {
                            <div style="height: 350px; position: relative;">
                                <canvas id="barChart"></canvas>
                            </div>
                        }
                        else
                        {
                            <div class="empty-state">
                                <i class="bi bi-graph-up"></i>
                                <p class="text-white">No hay transacciones en los últimos @selectedDays días</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Expenses Distribution Doughnut Chart -->
            <div class="col-lg-6" id="dashboard-expenses-by-category">
                <div class="glass-card animate-slide-up" style="animation-delay: 0.8s;">
                    <div class="card-header-glass">
                        <h5 class="mb-0 text-white fw-semibold">
                            <span style="font-size: 20px;">🧾</span>
                            Gastos por Categorias
                        </h5>
                    </div>
                    <div class="card-body-glass">
                        @if (expensesByCategoryData.Any())
                        {
                            <div style="height: 350px; position: relative; margin-bottom:1rem;">
                                <canvas id="expensesChart"></canvas>
                            </div>
                        }
                        else
                        {
                            <div class="empty-state-small">
                                <p class="text-white">No hay gastos en el período seleccionado</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Budget Doughnut Chart -->
            <div class="col-lg-6" id="dashboard-budget-chart">
                <div class="glass-card animate-slide-up" style="animation-delay: 0.6s;">
                    <div class="card-header-glass">
                        <h5 class="mb-0 text-white fw-semibold">
                            <span style="font-size: 20px;">💰</span>
                            % Presupuesto Gastado
                        </h5>
                    </div>
                    <div class="card-body-glass">
                        @if (budgetData.Any())
                        {
                            <div style="height: 250px; position: relative; margin-bottom: 1rem;">
                                <canvas id="budgetChart"></canvas>
                            </div>
                            <div class="budget-legend">
                                @foreach (var item in budgetData)
                                {
                                    <div class="legend-item @GetBudgetStatusClass(item.PercentageUsed)">
                                        <span class="legend-color"></span>
                                        <span class="legend-label">@item.CategoryName</span>
                                        <span class="legend-value">@item.PercentageUsed.ToString("F0")%</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="empty-state-small">
                                <p class="text-white">No tienes presupuestos activos</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Goals + Alerts -->
        <div class="row g-4 mb-4">
            <!-- Goals -->
            <div class="col-lg-6" id="dashboard-active-goals">
                <div class="glass-card h-100 animate-slide-up" style="animation-delay: 0.5s;">
                    <div class="card-header-glass">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-white fw-semibold">
                                <span style="font-size: 20px;">🎯</span>
                                Metas Activas
                            </h5>
                            <a href="/goals" class="glass-link-small">Ver todas →</a>
                        </div>
                    </div>
                    <div class="card-body-glass">
                        @if (topGoals.Any())
                        {
                            @foreach (var goal in topGoals)
                            {
                                var percentage = goal.TargetAmount > 0 ? (goal.CurrentAmount / goal.TargetAmount) * 100 : 0;
                                var daysRemaining = (goal.TargetDate - DateTime.Now).Days;

                                <div class="goal-item">
                                    <div class="goal-header">
                                        <span class="goal-name">@goal.Title</span>
                                        <span class="goal-percentage">@percentage.ToString("F0")%</span>
                                    </div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill" style="width: @percentage%"></div>
                                    </div>
                                    <div class="goal-footer">
                                        <span class="text-info">@goal.CurrentAmount.ToString("C0") / @goal.TargetAmount.ToString("C0")</span>
                                        @if (goal.Status != GoalStatus.Completed)
                                        {
                                            <span class="days-remaining text-white">@daysRemaining días</span>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-state-small">
                                <p class="text-white">No tienes metas activas</p>
                                <a href="/goals" class="glass-button-small text-white">Crear Meta</a>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Alerts Widget -->
            <div class="col-lg-6" id="dashboard-budget-alerts">
                <div class="glass-card animate-slide-up" style="animation-delay: 0.7s;">
                    <div class="card-header-glass">
                        <h5 class="mb-0 text-white fw-semibold">
                            <span style="font-size: 20px;">⚠️</span>
                            Alertas de Presupuestos
                        </h5>
                    </div>
                    <div class="card-body-glass">
                        @if (alerts.Any())
                        {
                            @foreach (var alert in alerts)
                            {
                                <div class="alert-item @alert.Type">
                                    <div class="alert-icon">@alert.Icon</div>
                                    <div class="alert-content">
                                        <strong>@alert.Title</strong>
                                        <p class="text-white">@alert.Message</p>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-state-small success">
                                <span style="font-size: 2rem;">✅</span>
                                <p class="text-white">¡Todo bajo control!</p>
                                <small class="text-white">No hay alertas</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="row g-4">
            <div class="col-12" id="dashboard-recent-transactions">
                <div class="glass-card">
                    <div class="card-header-glass">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h5 class="mb-0 text-white fw-semibold">
                                <span style="font-size: 32px;">💳</span>
                                Historial
                            </h5>
                            <a href="/transactions" class="glass-link" id="dashboard-view-all-link">
                                Ver todas <i class="bi bi-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                    <div class="card-body-glass">
                        @if (recentTransactions.Any())
                        {
                            <div class="table-responsive">
                                <table class="table-glass mb-0">
                                    <thead>
                                        <tr>
                                            <th class="text-white">Categoría</th>
                                            <th class="text-white">Monto</th>
                                            <th class="text-white">Descripción</th>
                                            <th class="text-white">Fecha</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var transaction in recentTransactions.Take(5))
                                        {
                                            <tr class="transaction-row">
                                                <td>
                                                    <div class="d-flex align-items-center gap-2">
                                                        <span style="font-size: 1.5rem;">@transaction.CategoryIcon</span>
                                                        <span class="text-white fw-semibold">@transaction.CategoryTitle</span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="fw-bold @(transaction.Type == TransactionType.Income ? "text-success" :
                                                          (transaction.Type == TransactionType.Expense ? "text-danger" : "text-info"))">

                                                      @if (transaction.Type == TransactionType.Income)
                                                         {
                                                           @:+@transaction.Amount.ToString("C0")
                                                         }
                                                         else if (transaction.Type == TransactionType.Expense)
                                                         {
                                                           @:-@transaction.Amount.ToString("C0")
                                                         }
                                                         else
                                                         {
                                                           @transaction.Amount.ToString("C0")
                                                         }
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="text-white">@transaction.Description</span>
                                                </td>
                                                <td>
                                                    <small class="text-white">@transaction.Date.ToString("dd/MM/yyyy")</small>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="empty-state">
                                <i class="bi bi-receipt"></i>
                                <p class="mb-3 text-white">No Hay Registros recientes</p>
                                <a href="/transactions" class="glass-button text-white">
                                    Registrar Gasto/Ingreso
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>
<FloatingHelpButton OnClick="StartTour" Icono="?" Titulo="Ayuda" Bottom="90" />

<FloatingHelpButton OnClick="GotoHome" Icono="🏠" Titulo="Ir al Inicio" Bottom="140" />

@code {
    // ===== VARIABLES DE ESTADO =====
    private bool isLoading = true;
    private bool _hasRenderedCharts = false;
    private string userId = string.Empty;
    private int selectedDays = 7;

    // Datos principales
    private List<CategoryDto> categories = new();
    private List<ExpenseIncomeDto> allTransactions = new();
    private List<ExpenseIncomeDto> recentTransactions = new();
    private List<BudgetDto> budgets = new();
    private List<FinancialGoalDto> allGoals = new();
    private List<FinancialGoalDto> topGoals = new();

    // Resúmenes
    private decimal balance = 0;
    private decimal totalIncome = 0;
    private decimal totalExpense = 0;
    private int totalGoalsCount = 0;
    private int completedGoalsCount = 0;
    private decimal totalAdjustments = 0;
    private decimal totalDebt = 0;
    private decimal totalOriginalAmount = 0;
    private int activeLoansCount = 0;

    // Datos para gráficos
    private Dictionary<string, DayData> chartData = new();
    private List<BudgetData> budgetData = new();
    private List<CategoryExpenseData> expensesByCategoryData = new();
    private List<AlertItem> alerts = new();

    // ===== CICLO DE VIDA DEL COMPONENTE =====

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
            await LoadDashboardData(); 
        }

        isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading && !_hasRenderedCharts)
        {
            _hasRenderedCharts = true;
            await RenderCharts();
        }

        if (firstRender && !isLoading)
        {
            // NUEVO: Iniciar tour automáticamente si es primera vez
            await Task.Delay(500); // Pequeño delay para que cargue la UI
            await JSRuntime.InvokeVoidAsync("tourService.startTourIfFirstTime", "dashboard");
        }
    }

    //Botones flotantes

    private async Task StartTour()
    {
        await JSRuntime.InvokeVoidAsync("tourService.startDashboardTour");
    }

    // Lógica para redirigir
    private void GotoHome()
    {
        Navigation.NavigateTo("/"); // Redirige al Home
    }

    private async Task ChangePeriod(int days)
    {
        selectedDays = days;
        await LoadDashboardData();
        await RenderCharts();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            isLoading = true;
            _hasRenderedCharts = false;

            if (string.IsNullOrEmpty(userId))
            {
                isLoading = false;
                return;
            }

            var endDate = DateTime.Now;
            var startDate = endDate.AddDays(-selectedDays);

            // Cargar datos básicos del período seleccionado
            var periodTransactions = await ExpenseIncomeService.GetByUserAndDateRangeAsync(userId, startDate, endDate);

            //  Calcular Ingresos (Solo TransactionType.Income)
            totalIncome = periodTransactions
                .Where(t => t.Type == TransactionType.Income) // <--- CORREGIDO: Usar Type directo
                .Sum(t => t.Amount);

            //  Calcular Gastos (Solo TransactionType.Expense)
            totalExpense = periodTransactions
                .Where(t => t.Type == TransactionType.Expense) // <--- CORREGIDO: Usar Type directo
                .Sum(t => t.Amount);

            //  Calcular Ajustes (Préstamos recibidos) para el Balance
            var totalAdjustments = periodTransactions
                .Where(t => t.Type == TransactionType.Adjustment)
                .Sum(t => t.Amount);

            //  Calcular Balance del período (Ingresos + Préstamos - Gastos)
            balance = totalIncome + totalAdjustments - totalExpense;

            // --- NUEVO: Obtener conteo de préstamos activos ---
            var activeLoans = await LoanService.GetActiveByUserAsync(userId);
            activeLoansCount = activeLoans.Count;

            //  CALCULAR DEUDA TOTAL - Sumamos lo que falta por pagar de las cuotas
            totalDebt = activeLoans.Sum(l => (l.NumberOfInstallments - l.InstallmentsPaid) * l.InstallmentAmount);

            //  CALCULAR CAPITAL PENDIENTE - Usamos el saldo real de la BD
            totalOriginalAmount = activeLoans.Sum(l => l.CurrentBalance);

            // Cargar transacciones recientes
            recentTransactions = await ExpenseIncomeService.GetRecentTransactionsAsync(userId, 10);

            // Cargar categorías
            categories = await CategoryService.GetAllByUserAsync(userId);

            // Cargar todas las transacciones para gráficos
            allTransactions = await ExpenseIncomeService.GetByUserAndDateRangeAsync(userId, startDate.AddDays(-30), endDate);

            // Cargar datos de metas
            allGoals = await GoalService.GetAllByUserAsync(userId);
            totalGoalsCount = allGoals.Count;
            completedGoalsCount = await GoalService.GetCompletedGoalsCountAsync(userId);

            // Preparar top metas activas
            PrepareTopGoals();

            // Calcular datos del gráfico de barras
            await CalculateChartData();

            // Preparar datos de presupuestos
            await PrepareBudgetData();

            // Preparar datos de gastos por categoría
            await PrepareExpensesByCategoryData();

            // Generar alertas
            GenerateAlerts();

            isLoading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ ERROR en LoadDashboardData: {ex.Message}");
            isLoading = false;
        }
    }

    private Task CalculateChartData()
    {
        var endDate = DateTime.Now.Date;
        var startDate = endDate.AddDays(-(selectedDays - 1));

        var transactions = allTransactions
            .Where(t => t.Date.Date >= startDate && t.Date.Date <= endDate)
            .ToList();

        chartData.Clear();

        if (selectedDays == 7)
        {
            for (int i = 0; i < selectedDays; i++)
            {
                var date = startDate.AddDays(i);
                var dayLabel = date.ToString("ddd dd");

                var dayTransactions = transactions.Where(t => t.Date.Date == date).ToList();

                var income = dayTransactions
                    .Where(t => t.Type == TransactionType.Income) // Solo Ingresos reales
                    .Sum(t => t.Amount);

                var expense = dayTransactions
                    .Where(t => t.Type == TransactionType.Expense) // Solo Gastos reales
                    .Sum(t => t.Amount);

                chartData[dayLabel] = new DayData { Income = income, Expense = expense };
            }
        }
        else
        {
            int weekNumber = 1;
            for (int i = 0; i < selectedDays; i += 7)
            {
                var weekStart = startDate.AddDays(i);
                var weekEnd = weekStart.AddDays(6);
                if (weekEnd > endDate) weekEnd = endDate;

                var weekLabel = $"Sem {weekNumber}";

                var weekTransactions = transactions
                    .Where(t => t.Date.Date >= weekStart && t.Date.Date <= weekEnd)
                    .ToList();

                var income = weekTransactions
                    .Where(t => GetCategoryType(t.CategoryId) == TransactionType.Income)
                    .Sum(t => t.Amount);

                var expense = weekTransactions
                    .Where(t => GetCategoryType(t.CategoryId) == TransactionType.Expense)
                    .Sum(t => t.Amount);

                chartData[weekLabel] = new DayData { Income = income, Expense = expense };
                weekNumber++;
            }
        }

        return Task.CompletedTask;
    }

    private async Task PrepareBudgetData()
    {
        var now = DateTime.Now;
        budgetData.Clear();

        // Obtener presupuestos del mes y año actual
        budgets = await BudgetService.GetByUserAndPeriodAsync(userId, now.Month, now.Year);

        foreach (var budget in budgets)
        {
            var percentage = budget.AssignedAmount > 0 ? (budget.SpentAmount / budget.AssignedAmount) * 100 : 0;

            budgetData.Add(new BudgetData
            {
                CategoryName = budget.CategoryTitle ?? "Sin categoría",
                CategoryIcon = budget.CategoryIcon ?? "📁",
                BudgetAmount = budget.AssignedAmount,
                SpentAmount = budget.SpentAmount,
                PercentageUsed = percentage
            });
        }
    }

    private Task PrepareExpensesByCategoryData()
    {
        expensesByCategoryData.Clear();

        var endDate = DateTime.Now;
        var startDate = endDate.AddDays(-selectedDays);

        var periodTransactions = allTransactions
            .Where(t => t.Date.Date >= startDate && t.Date.Date <= endDate)
            .ToList();

        var expenses = periodTransactions
            .Where(t => t.Type == TransactionType.Expense) //  Solo Transacciones que sean Gasto real
            .ToList();

        if (!expenses.Any())
            return Task.CompletedTask;

        var groupedByCategory = expenses
            .GroupBy(e => new { e.CategoryId, e.CategoryTitle, e.CategoryIcon })
            .Select(g => new
            {
                CategoryId = g.Key.CategoryId,
                CategoryName = g.Key.CategoryTitle ?? "Sin categoría",
                CategoryIcon = g.Key.CategoryIcon ?? "📁",
                TotalExpense = g.Sum(e => e.Amount)
            })
            .OrderByDescending(x => x.TotalExpense)
            .ToList();

        var colors = new[]
        {
        "#f44336", "#e91e63", "#9c27b0", "#673ab7",
        "#3f51b5", "#2196f3", "#03a9f4", "#00bcd4",
        "#009688", "#4caf50", "#8bc34a", "#cddc39",
        "#ffeb3b", "#ffc107", "#ff9800", "#ff5722"
    };

        int colorIndex = 0;
        foreach (var item in groupedByCategory)
        {
            expensesByCategoryData.Add(new CategoryExpenseData
            {
                CategoryName = item.CategoryName,
                CategoryIcon = item.CategoryIcon,
                TotalExpense = item.TotalExpense,
                Color = colors[colorIndex % colors.Length]
            });
            colorIndex++;
        }

        return Task.CompletedTask;
    }

    private void PrepareTopGoals()
    {
        topGoals = allGoals
            .Where(g => g.Status != GoalStatus.Completed)
            .OrderByDescending(g => g.TargetAmount > 0 ? (g.CurrentAmount / g.TargetAmount) : 0)
            .Take(5)
            .ToList();
    }

    private void GenerateAlerts()
    {
        alerts = new List<AlertItem>();

        var exceededBudgets = budgetData.Where(b => b.PercentageUsed >= 100).ToList();
        foreach (var budget in exceededBudgets)
        {
            alerts.Add(new AlertItem
            {
                Type = "danger",
                Icon = "🔴",
                Title = $"{budget.CategoryName} excedido",
                Message = $"Has gastado {budget.SpentAmount:C} de {budget.BudgetAmount:C}"
            });
        }

        var warningBudgets = budgetData.Where(b => b.PercentageUsed >= 80 && b.PercentageUsed < 100).ToList();
        foreach (var budget in warningBudgets)
        {
            alerts.Add(new AlertItem
            {
                Type = "warning",
                Icon = "🟡",
                Title = $"{budget.CategoryName} cerca del límite",
                Message = $"Has gastado {budget.PercentageUsed:F0}% del presupuesto"
            });
        }

        var urgentGoals = allGoals
            .Where(g => g.Status != GoalStatus.Completed
                && (g.TargetDate - DateTime.Now).Days <= 30
                && (g.TargetDate - DateTime.Now).Days > 0)
            .ToList();

        foreach (var goal in urgentGoals)
        {
            var daysLeft = (goal.TargetDate - DateTime.Now).Days;
            alerts.Add(new AlertItem
            {
                Type = "info",
                Icon = "🎯",
                Title = $"Meta '{goal.Title}' próxima",
                Message = $"Vence en {daysLeft} días"
            });
        }

        alerts = alerts.Take(5).ToList();
    }

    private async Task RenderCharts()
    {
        try
        {
            var chartExists = await JSRuntime.InvokeAsync<bool>("eval",
                "typeof chartHelpers !== 'undefined'");

            if (!chartExists)
            {
                Console.WriteLine("⚠️ chartHelpers no está disponible aún");
                return;
            }

            // Gráfico de barras (ingresos vs gastos)
            if (chartData.Any())
            {
                var labels = chartData.Keys.ToArray();
                var incomeData = chartData.Values.Select(d => (double)d.Income).ToArray();
                var expenseData = chartData.Values.Select(d => (double)d.Expense).ToArray();

                await JSRuntime.InvokeVoidAsync("chartHelpers.createBarChart",
                    "barChart", labels, incomeData, expenseData);
            }

            // Gráfico de presupuestos
            if (budgetData.Any())
            {
                var labels = budgetData.Select(b => b.CategoryName).ToArray();
                var values = budgetData.Select(b => b.PercentageUsed).ToArray();
                var colors = budgetData.Select(b => GetBudgetColor(b.PercentageUsed)).ToArray();

                await JSRuntime.InvokeVoidAsync("chartHelpers.createBudgetChart",
                    "budgetChart", labels, values, colors);
            }

            // Gráfico de distribución de gastos por categoría
            if (expensesByCategoryData.Any())
            {
                var labels = expensesByCategoryData.Select(e => e.CategoryName).ToArray();
                var values = expensesByCategoryData.Select(e => (double)e.TotalExpense).ToArray();
                var colors = expensesByCategoryData.Select(e => e.Color).ToArray();

                await JSRuntime.InvokeVoidAsync("chartHelpers.createDoughnutChart",
                    "expensesChart", labels, values, colors);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error rendering charts: {ex.Message}");
        }
    }

    private TransactionType GetCategoryType(int categoryId)
    {
        return categories.FirstOrDefault(c => c.CategoryId == categoryId)?.Type ?? TransactionType.Expense;
    }

    private string GetBudgetStatusClass(decimal percentage)
    {
        if (percentage >= 100) return "status-exceeded";
        if (percentage >= 80) return "status-warning";
        return "status-ok";
    }

    private string GetBudgetColor(decimal percentage)
    {
        if (percentage >= 100) return "#f44336";
        if (percentage >= 80) return "#ffc107";
        return "#4CAF50";
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("chartHelpers.destroyChart", "barChart");
            await JSRuntime.InvokeVoidAsync("chartHelpers.destroyChart", "budgetChart");
            await JSRuntime.InvokeVoidAsync("chartHelpers.destroyChart", "expensesChart");
        }
        catch { }
    }

    // ===== CLASES AUXILIARES =====

    private class DayData
    {
        public decimal Income { get; set; }
        public decimal Expense { get; set; }
    }

    public class BudgetData
    {
        public string CategoryName { get; set; } = "";
        public string CategoryIcon { get; set; } = "";
        public decimal BudgetAmount { get; set; }
        public decimal SpentAmount { get; set; }
        public decimal PercentageUsed { get; set; }
    }

    public class CategoryExpenseData
    {
        public string CategoryName { get; set; } = "";
        public string CategoryIcon { get; set; } = "";
        public decimal TotalExpense { get; set; }
        public string Color { get; set; } = "";
    }

    public class AlertItem
    {
        public string Type { get; set; } = "";
        public string Icon { get; set; } = "";
        public string Title { get; set; } = "";
        public string Message { get; set; } = "";
    }
}

