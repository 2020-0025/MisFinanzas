@* Archivo: Shared/AIAssistantModal.razor *@
@using MisFinanzas.Domain.DTOs
@using MisFinanzas.Infrastructure.Interfaces
@using System.Security.Claims
@using Microsoft.JSInterop
@inject IAIAssistantService AIService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ICommandParserService CommandParser
@inject ICommandExecutorService CommandExecutor
@inject IJSRuntime JSRuntime


@if (IsVisible)
{
    <div class="ai-modal-overlay">
        <div class="ai-modal-container" @onclick:stopPropagation="true">
            <!-- Header -->
            <div class="ai-modal-header">
                <div class="ai-modal-title" style="display:flex;">
                    <span class="ai-icon">🤖</span>
                    <h5 class="mb-0">Finn</h5>
                </div>
                <button type="button" class="ai-modal-close" @onclick="Close" title="Cerrar">
                    ✕
                </button>
            </div>

            <!-- Body - Chat -->
            <div class="ai-modal-body" @ref="chatContainer">
                @if (!AIService.IsAvailable())
                {
                    <div class="ai-warning">
                        <span style="font-size: 2rem;">⚠️</span>
                        <p>El asistente de IA no está configurado.</p>
                        <small>Por favor, configura la API key de Google Gemini en appsettings.</small>
                    </div>
                }
                else if (messages.Count == 0)
                {
                    <div class="ai-welcome">
                        <span style="font-size: 3rem;">👋</span>
                        <h6>¡Hola! Soy Finn 🤖</h6>
                        <p class="text-white mb-3">Tu asistente financiero personal. Puedo ayudarte con:</p>
                        <ul class="ai-capabilities">
                            <li>💰 Consultar tus gastos e ingresos</li>
                            <li>📊 Analizar tus presupuestos</li>
                            <li>🎯 Revisar tus metas financieras</li>
                            <li>💳 Información sobre tus préstamos</li>
                            <li>💡 Darte consejos personalizados</li>
                            <li>⚡ <strong>Crear gastos e ingresos automáticamente</strong></li>
                            <li>🤖 <strong>Ejecutar acciones con comandos de texto y voz</strong></li>
                        </ul>
                        <p class="text-white mt-3"><strong>¿En qué puedo ayudarte hoy?</strong></p>
                    </div>
                }
                else
                {
                    <div class="ai-messages">
                        @foreach (var message in messages)
                        {
                            <div class="ai-message @(message.Role == "user" ? "ai-message-user" : "ai-message-assistant")">
                                <div class="ai-message-content">
                                    @if (message.Role == "assistant")
                                    {
                                        <span class="ai-message-icon">🤖</span>
                                    }
                                    <div class="ai-message-text">
                                        @((MarkupString)FormatMessage(message.Content))
                                    </div>
                                    @if (message.Role == "user")
                                    {
                                        <span class="ai-message-icon">👤</span>
                                    }
                                </div>
                                <small class="ai-message-time">@message.Timestamp.ToString("HH:mm")</small>
                            </div>
                        }
                        @if (isLoading)
                        {
                            <div class="ai-message ai-message-assistant">
                                <div class="ai-message-content">
                                    <span class="ai-message-icon">🤖</span>
                                    <div class="ai-typing">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (pendingCommand != null)
                {
                    <div class="ai-command-confirmation">
                        <div class="ai-command-header">
                            <span style="font-size: 1.5rem;">⚡</span>
                            <strong>Comando detectado</strong>
                        </div>
                        <p class="ai-command-message">@pendingCommand.ConfirmationMessage</p>
                        <div class="ai-command-actions">
                            <button type="button" class="ai-confirm-btn" @onclick="ConfirmCommand" disabled="@isExecutingCommand">
                                @if (isExecutingCommand)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                ✅ Confirmar
                            </button>
                            <button type="button" class="ai-cancel-btn" @onclick="CancelCommand" disabled="@isExecutingCommand">
                                ❌ Cancelar
                            </button>
                        </div>
                    </div>
                }

            </div>

            <!-- Footer - Input -->
            <div class="ai-modal-footer">
                @if (isListening)
                {
                    <div class="listening-indicator">
                        <span class="spinner-grow spinner-grow-sm text-danger" role="status"></span>
                        <span>Escuchando... @tempSpeechText</span>
                    </div>
                }

                <div class="ai-input-container">
                    <button type="button"
                            class="mic-btn @(isListening ? "mic-active" : "")"
                            @onclick="ToggleVoiceRecording"
                            title="@(isListening ? "Detener grabación" : "Hablar")">
                        🎤
                    </button>

                    <input type="text"
                           class="ai-input"
                           placeholder="@(isListening ? "Habla ahora..." : "Escribe tu pregunta...")"
                           @bind="userInput"
                           @bind:event="oninput"
                           @onkeydown="HandleKeyDown"
                           disabled="@(!AIService.IsAvailable() || isLoading)" />

                    <button type="button"
                            class="ai-send-btn"
                            @onclick="SendMessage"
                            disabled="@(string.IsNullOrWhiteSpace(userInput) || !AIService.IsAvailable() || isLoading)">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {
                            <span>📤</span>
                        }
                    </button>
                </div>
                @if (messages.Count > 0)
                {
                    <button type="button" class="ai-clear-btn" @onclick="ClearChat">
                        🗑️ Limpiar chat
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    private ElementReference chatContainer;
    private List<AIMessageDto> messages = new();
    private string userInput = string.Empty;
    private bool isLoading = false;
    private string? currentUserId;
    private CommandDto? pendingCommand = null;
    private bool isExecutingCommand = false;

    // Variables para voz
    private bool isListening = false;
    private bool isVoiceSupported = false;
    private string tempSpeechText = ""; // Texto parcial mientras habla
    private DotNetObjectReference<AIAssistantModal>? dotNetRef;


    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Inicializar referencia JS y verificar soporte
            dotNetRef = DotNetObjectReference.Create(this);
            isVoiceSupported = await JSRuntime.InvokeAsync<bool>("aiVoice.initialize", dotNetRef);
        }
    }

    private async Task ToggleVoiceRecording()
    {
        if (!isVoiceSupported)
        {
            // Fallback simple si no hay soporte
            messages.Add(new AIMessageDto { Role = "assistant", Content = "⚠️ Tu navegador no soporta reconocimiento de voz.", Timestamp = DateTime.Now });
            return;
        }

        if (isListening)
        {
            await JSRuntime.InvokeVoidAsync("aiVoice.stopRecording");
            // El estado cambiará en OnSpeechEnd
        }
        else
        {
            tempSpeechText = "";
            await JSRuntime.InvokeVoidAsync("aiVoice.startRecording");
            // El estado cambiará en OnSpeechStart
        }
    }

    // --- MÉTODOS LLAMADOS DESDE JS ---

    [JSInvokable]
    public void OnSpeechStart()
    {
        isListening = true;
        StateHasChanged();
    }

    [JSInvokable]
    public void OnSpeechEnd()
    {
        isListening = false;
        tempSpeechText = "";
        // Opcional: Auto-enviar si hay texto
        // if (!string.IsNullOrWhiteSpace(userInput)) SendMessage();
        StateHasChanged();
    }

    [JSInvokable]
    public void OnSpeechResult(string finalTranscript, string interimTranscript)
    {
        // Actualizamos el input principal con lo confirmado
        if (!string.IsNullOrEmpty(finalTranscript))
        {
            userInput = (userInput + " " + finalTranscript).Trim();
        }

        // Mostramos lo temporal en el indicador flotante
        tempSpeechText = interimTranscript;

        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnSpeechError(string error)
    {
        isListening = false;
        Console.WriteLine($"Error de voz: {error}");

        string errorMessage;

        // Personalizar mensaje según el error
        if (error == "network")
        {
            errorMessage = "⚠️ Tu navegador no permite servicios de voz en la nube (común en Brave). Intenta con Chrome o Edge.";
        }
        else if (error == "not-allowed" || error == "permission-denied")
        {
            errorMessage = "⚠️ Necesitas dar permiso al micrófono para usar esta función.";
        }
        else if (error == "no-speech")
        {
            // Si no habló, simplemente reseteamos sin mensaje de error
            StateHasChanged();
            return;
        }
        else
        {
            errorMessage = $"⚠️ No pude escucharte bien ({error}). Intenta de nuevo.";
        }

        // Agregar mensaje al chat para que el usuario lo vea
        messages.Add(new AIMessageDto
        {
            Role = "assistant",
            Content = errorMessage,
            Timestamp = DateTime.Now
        });

        StateHasChanged();
        await ScrollToBottom();
    }

    

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(userInput) || string.IsNullOrEmpty(currentUserId))
            return;

        var userMessage = userInput.Trim();
        userInput = string.Empty;

        // Agregar mensaje del usuario
        messages.Add(new AIMessageDto
        {
            Role = "user",
            Content = userMessage,
            Timestamp = DateTime.Now
        });

        isLoading = true;
        StateHasChanged();
        await ScrollToBottom();

        // PASO 1: Detectar si es un comando
        var command = await CommandParser.ParseCommandAsync(userMessage, currentUserId);

        if (command != null)
        {
            // Es un comando - mostrar confirmación
            pendingCommand = command;
            isLoading = false;
            StateHasChanged();
            return;
        }

        // No es comando - procesar como conversación normal
        var conversationHistory = messages.Take(messages.Count - 1).ToList();
        var response = await AIService.SendMessageAsync(userMessage, currentUserId, conversationHistory);

        messages.Add(response);
        isLoading = false;
        StateHasChanged();
        await ScrollToBottom();
    }


    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private void ClearChat()
    {
        messages.Clear();
        userInput = string.Empty;
        StateHasChanged();
    }

    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
    }

    private async Task ScrollToBottom()
    {
        await Task.Delay(100);
        StateHasChanged();
    }

    private string FormatMessage(string content)
    {
        if (string.IsNullOrEmpty(content))
            return string.Empty;

        // Convertir saltos de línea a <br>
        content = content.Replace("\n", "<br>");

        // Convertir **negrita** a <strong>
        content = System.Text.RegularExpressions.Regex.Replace(content, @"\*\*(.*?)\*\*", "<strong>$1</strong>");

        return content;
    }

    private async Task ConfirmCommand()
    {
        if (pendingCommand == null || string.IsNullOrEmpty(currentUserId))
            return;

        isExecutingCommand = true;
        StateHasChanged();

        // Ejecutar el comando
        var result = await CommandExecutor.ExecuteCommandAsync(pendingCommand, currentUserId);

        // Preparamos el mensaje de respuesta
        var responseContent = result.Message;

        // Si hubo error y hay detalles técnicos, los agregamos ocultos o visibles para contexto
        if (!result.Success && !string.IsNullOrEmpty(result.ErrorDetails))
        {
            // Agregamos el detalle técnico para que la IA tenga contexto si el usuario pregunta "por qué?"
            // Lo ponemos entre paréntesis o en una nota al pie.
            responseContent += $"\n\n(Detalle del sistema: {result.ErrorDetails})";
        }

        messages.Add(new AIMessageDto
        {
            Role = "assistant",
            Content = responseContent,
            Timestamp = DateTime.Now
        });

        // Limpiar estado
        pendingCommand = null;
        isExecutingCommand = false;
        StateHasChanged();
        await ScrollToBottom();
    }

    private void CancelCommand()
    {
        // Agregar mensaje de cancelación
        messages.Add(new AIMessageDto
        {
            Role = "assistant",
            Content = "❌ Comando cancelado. ¿En qué más puedo ayudarte?",
            Timestamp = DateTime.Now
        });

        pendingCommand = null;
        StateHasChanged();
    }

    public void Dispose()
    {
        dotNetRef?.Dispose();
    }

}
