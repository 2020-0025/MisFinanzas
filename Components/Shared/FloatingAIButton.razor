@* Archivo: Shared/FloatingAIButton.razor *@
@inject IJSRuntime JSRuntime

<div class="fab-ai-container" style="bottom: @(Bottom)px;">
    <div class="ai-greeting @(showGreeting ? "show" : "")">
        ¿Te ayudo con algo? 👋
    </div>

    <button class="fab-ai"
            @onclick="OnClick"
            @onmouseenter="ShowGreeting"
            @onmouseleave="HideGreeting"
            title="Finn"
            id="@Id">
        🤖
    </button>
</div>

@code {
    [Parameter]
    public EventCallback OnClick { get; set; }

    [Parameter]
    public int Bottom { get; set; } = 200;

    [Parameter]
    public string? Id { get; set; }

    private bool showGreeting = false;
    private System.Threading.Timer? greetingTimer;


    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        // Solo iniciar el timer la primera vez que se renderiza en el cliente
        if (firstRender)
        {
            // Iniciar el primer chequeo a los 3 segundos
            greetingTimer = new System.Threading.Timer(async _ =>
            {
                try
                {
                    bool isTourActive = false;

                    // 1. Preguntar si hay tour
                    await InvokeAsync(async () =>
                    {
                        try
                        {
                            isTourActive = await JSRuntime.InvokeAsync<bool>("tourService.isTourActive");
                        }
                        catch
                        {
                            // Si falla la llamada JS (navegación rápida), asumir falso para no bloquear
                            isTourActive = false;
                        }
                    });

                    // 2. Si hay tour, NO saludar todavía, PERO volver a preguntar en 2 segundos
                    if (isTourActive)
                    {
                        // Reprogramar el timer para chequear de nuevo en 2000ms (2s)
                        greetingTimer?.Change(2000, System.Threading.Timeout.Infinite);
                        return;
                    }

                    // 3. Si NO hay tour, mostrar el saludo
                    await InvokeAsync(() =>
                    {
                        showGreeting = true;
                        StateHasChanged();
                    });

                    // 4. Ocultar automáticamente después de 5 segundos
                    await Task.Delay(5000);

                    await InvokeAsync(() =>
                    {
                        showGreeting = false;
                        StateHasChanged();
                    });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error en saludo de Finn: {ex.Message}");
                }
            }, null, 3000, System.Threading.Timeout.Infinite);
        }

        return Task.CompletedTask;
    }

    private void ShowGreeting()
    {
        showGreeting = true;
    }

    private void HideGreeting()
    {
        showGreeting = false;
    }

    public void Dispose()
    {
        greetingTimer?.Dispose();
    }
}