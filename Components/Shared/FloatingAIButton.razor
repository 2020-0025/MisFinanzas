@* Archivo: Shared/FloatingAIButton.razor *@
@inject IJSRuntime JSRuntime

<div class="fab-ai-container" style="bottom: @(Bottom)px;">
    <div class="ai-greeting @(showGreeting ? "show" : "")">
        ¿Te ayudo con algo?
    </div>

    <button class="fab-ai"
            @onclick="OnClick"
            @onmouseenter="ShowGreeting"
            @onmouseleave="HideGreeting"
            title="Finn"
            id="@Id">
        🤖
    </button>
</div>

@code {
    [Parameter]
    public EventCallback OnClick { get; set; }

    [Parameter]
    public int Bottom { get; set; } = 200; 

    [Parameter]
    public string? Id { get; set; }

    private bool showGreeting = false;
    private System.Threading.Timer? greetingTimer;

    protected override void OnInitialized()
    {
        // Iniciamos el primer chequeo a los 3 segundos
        greetingTimer = new System.Threading.Timer(async _ =>
        {
            try
            {
                bool isTourActive = false;

                // 1. Preguntamos si hay tour
                await InvokeAsync(async () =>
                {
                    isTourActive = await JSRuntime.InvokeAsync<bool>("tourService.isTourActive");
                });

                // 2. Si hay tour, NO saludamos todavía, PERO volvemos a preguntar en 2 segundos
                if (isTourActive)
                {
                    // Reprogramar el timer para chequear de nuevo en 2000ms (2s)
                    greetingTimer?.Change(2000, System.Threading.Timeout.Infinite);
                    return;
                }

                // 3. Si NO hay tour, mostramos el saludo
                await InvokeAsync(() =>
                {
                    showGreeting = true;
                    StateHasChanged();
                });

                // 4. Ocultar automáticamente después de 5 segundos
                await Task.Delay(5000);

                await InvokeAsync(() =>
                {
                    showGreeting = false;
                    StateHasChanged();
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error en saludo de Finn: {ex.Message}");
            }
        }, null, 3000, System.Threading.Timeout.Infinite);
    }

    private void ShowGreeting()
    {
        showGreeting = true;
    }

    private void HideGreeting()
    {
        // Pequeño delay para que no parpadee si el mouse sale y entra rápido
        // En este caso simple, lo ocultamos directo o dejamos que el usuario lo vea
        showGreeting = false;
    }

    public void Dispose()
    {
        greetingTimer?.Dispose();
    }
}
